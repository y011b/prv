<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AetherLink: Enhanced Edition</title>
    
    <!-- CDNs & Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    /* Color Palettes */
    :root {
        /* Default Dark Mode Palette */
        --bg-primary: #111827;
        --bg-secondary: #1F2937;
        --bg-tertiary: #374151;
        --bg-input: #374151;
        --text-primary: #F9FAFB;
        --text-secondary: #D1D5DB;
        --text-tertiary: #9CA3AF;
        --accent-purple: #8B5CF6;
        --accent-purple-darker: #7C3AED;
        --border-color: #374151;
        --system-message-bg: rgba(59, 130, 246, 0.15);
        --system-message-text: #93C5FD;
        --success-green: #4ADE80;
        --error-red: #F87171;
        --warning-yellow: #FBBF24;
        --call-active: #3B82F6;
    }

    /* Ocean Blue Palette */
    [data-theme="ocean-blue"] {
        --bg-primary: #0c1445;
        --bg-secondary: #162b6f;
        --bg-tertiary: #1d3a8a;
        --accent-purple: #3B82F6;
        --accent-purple-darker: #2563EB;
    }

    /* Forest Green Palette */
    [data-theme="forest-green"] {
        --bg-primary: #0d2c1a;
        --bg-secondary: #1a472a;
        --bg-tertiary: #2e8b57;
        --accent-purple: #10B981;
        --accent-purple-darker: #059669;
    }

    /* Sunset Orange Palette */
    [data-theme="sunset-orange"] {
        --bg-primary: #451a03;
        --bg-secondary: #7c2d12;
        --bg-tertiary: #ea580c;
        --accent-purple: #F97316;
        --accent-purple-darker: #EA580C;
    }

    /* Royal Purple Palette */
    [data-theme="royal-purple"] {
        --bg-primary: #1e0d33;
        --bg-secondary: #3e206d;
        --bg-tertiary: #6D28D9;
        --accent-purple: #8B5CF6;
        --accent-purple-darker: #7C3AED;
    }

    /* Typography & Layout */
    :root {
        --font-family: 'Inter', sans-serif;
        --sidebar-width: 280px;
        --radius-lg: 16px;
        --radius-md: 12px;
        --radius-sm: 8px;
        --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.4), 0 8px 10px -6px rgb(0 0 0 / 0.4);
    }

    /* --- Global Styles --- */
    *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html, body {
        height: 100%;
        overflow: hidden;
        background-color: var(--bg-primary);
        font-family: var(--font-family);
        color: var(--text-secondary);
        font-size: 16px;
        transition: background-color 0.3s ease;
    }

    /* --- Main App Layout --- */
    .app-container {
        display: flex;
        height: 100vh;
        width: 100vw;
        position: relative;
        background-color: var(--bg-secondary);
        transition: transform 0.3s ease-in-out;
    }

    /* --- Sidebar --- */
    .sidebar {
        width: var(--sidebar-width);
        height: 100%;
        background-color: var(--bg-primary);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        transition: transform 0.3s ease-in-out;
    }

    .sidebar-header, .sidebar-footer {
        padding: 20px;
        flex-shrink: 0;
    }

    .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-color);
    }
    
    .sidebar-header-actions {
        display: flex;
        gap: 8px;
    }

    .logo { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
    }
    .logo i { 
        font-size: 1.8rem; 
        color: var(--accent-purple); 
    }
    .logo-text { 
        font-size: 1.25rem; 
        font-weight: 700; 
        color: var(--text-primary); 
    }

    .add-contact-btn { 
        background: none; 
        border: none; 
        cursor: pointer; 
        padding: 6px; 
        border-radius: var(--radius-sm); 
        transition: background-color 0.2s ease; 
        color: var(--text-secondary);
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .add-contact-btn:hover { 
        background-color: var(--bg-tertiary); 
    }

    .sidebar-close-btn {
        display: none;
    }

    .contact-list { 
        list-style: none; 
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 8px; 
    }

    .contact-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        margin-bottom: 4px;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0;
        transform: translateY(10px);
        animation: fadeInSlideUp 0.5s ease forwards;
        position: relative;
    }

    .contact-item:hover { 
        background-color: var(--bg-tertiary); 
    }
    .contact-item.active {
        background: var(--accent-purple);
        color: white;
        box-shadow: var(--shadow-medium);
    }
    .contact-item.active .contact-name { 
        color: white; 
    }
    .contact-item.active .delete-contact-btn { 
        color: white; 
    }
    
    .contact-name { 
        font-weight: 500; 
        color: var(--text-primary); 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
        flex-grow: 1;
        padding-right: 10px;
    }
    
    .contact-actions {
        display: flex;
        gap: 8px;
    }
    
    .contact-action-btn {
        background: none;
        border: none;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
        padding: 4px;
        border-radius: 50%;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    
    .contact-action-btn:hover {
        opacity: 1;
        background-color: rgba(255,255,255,0.1);
    }
    
    .pinned .contact-name::before {
        content: "\f08d";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        margin-right: 8px;
        color: var(--warning-yellow);
    }

    .sidebar-footer { 
        border-top: 1px solid var(--border-color); 
    }
    .your-id-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 8px; 
    }
    .your-id-title { 
        font-size: 0.875rem; 
        font-weight: 600; 
        color: var(--text-primary); 
    }
    .your-id-actions { 
        display: flex; 
        gap: 8px; 
    }
    .id-action-btn { 
        background: none; 
        border: none; 
        cursor: pointer; 
        padding: 4px; 
        border-radius: var(--radius-sm); 
        transition: background-color 0.2s ease; 
        color: var(--text-secondary);
    }
    .id-action-btn:hover { 
        background-color: var(--bg-tertiary); 
    }
    .your-id-display { 
        background-color: var(--bg-input); 
        padding: 8px 12px; 
        border-radius: var(--radius-md); 
        font-family: monospace; 
        font-size: 0.8rem; 
        color: var(--text-tertiary); 
        word-break: break-all; 
        text-align: center; 
    }

    /* --- Chat Area --- */
    .chat-area { 
        flex-grow: 1; 
        display: flex; 
        flex-direction: column; 
        background-color: var(--bg-secondary); 
        height: 100vh; 
    }
    .chat-header { 
        display: flex; 
        align-items: center; 
        padding: 16px 24px; 
        border-bottom: 1px solid var(--border-color); 
        flex-shrink: 0; 
        gap: 12px; 
    }
    .hamburger-menu { 
        display: none; 
        background: none; 
        border: none; 
        cursor: pointer; 
        padding: 4px; 
        color: var(--text-secondary);
        font-size: 1.4rem;
    }
    .chat-contact-info { 
        flex-grow: 1; 
    }
    .chat-contact-name { 
        font-size: 1.125rem; 
        font-weight: 600; 
        color: var(--text-primary); 
    }
    .chat-contact-status { 
        font-size: 0.875rem; 
        color: var(--text-tertiary); 
    }
    .chat-contact-status.connected { 
        color: var(--success-green); 
    }
    .chat-contact-status.disconnected { 
        color: var(--error-red); 
    }
    .chat-actions { 
        display: flex; 
        align-items: center; 
        gap: 12px; 
    }
    .chat-action-btn { 
        background: none; 
        border: none; 
        cursor: pointer; 
        padding: 8px; 
        border-radius: var(--radius-sm); 
        transition: all 0.2s ease; 
        color: var(--text-secondary);
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .chat-action-btn:hover:not(:disabled) { 
        background-color: var(--bg-tertiary); 
    }
    .chat-action-btn:disabled { 
        cursor: not-allowed; 
        opacity: 0.4; 
    }
    
    .chat-action-btn.active {
        background-color: var(--accent-purple);
        color: white;
    }

    .ghost-mode-toggle { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        font-size: 0.875rem; 
        padding: 6px 10px; 
        border-radius: var(--radius-md); 
    }
    .ghost-mode-toggle.active { 
        background-color: var(--accent-purple); 
        color: white; 
    }

    .message-list { 
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 24px; 
        display: flex; 
        flex-direction: column; 
        gap: 16px; 
    }
    .empty-chat { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        height: 100%; 
        text-align: center; 
        color: var(--text-tertiary); 
    }
    .empty-chat-logo { 
        margin-bottom: 16px; 
    }
    .empty-chat-logo i { 
        font-size: 4rem; 
        color: var(--bg-primary); 
    }
    .empty-chat h2 { 
        font-size: 1.5rem; 
        color: var(--text-primary); 
        margin-bottom: 8px; 
    }

    .message-item { 
        display: flex; 
        max-width: 75%; 
        opacity: 0; 
        transform: translateY(10px); 
        animation: fadeInSlideUp 0.5s ease forwards; 
        transition: opacity 0.5s ease, transform 0.5s ease; 
    }
    .message-item.disappearing { 
        opacity: 0; 
        transform: scale(0.8); 
    }
    .message-item.mine { 
        align-self: flex-end; 
    }
    .message-item.theirs { 
        align-self: flex-start; 
    }
    .message-item.system { 
        align-self: center; 
        max-width: 100%; 
    }

    .message-bubble { 
        padding: 12px 16px; 
        border-radius: var(--radius-lg); 
        position: relative; 
        box-shadow: var(--shadow-soft); 
    }
    .message-bubble.mine { 
        background-image: linear-gradient(to right, var(--accent-purple), var(--accent-purple-darker)); 
        color: white; 
        border-bottom-right-radius: var(--radius-sm); 
    }
    .message-bubble.theirs { 
        background-color: var(--bg-tertiary); 
        color: var(--text-primary); 
        border-bottom-left-radius: var(--radius-sm); 
    }
    .message-bubble.system { 
        background-color: var(--system-message-bg); 
        color: var(--system-message-text); 
        font-size: 0.875rem; 
        text-align: center; 
    }
    .message-content img { 
        max-width: 100%; 
        border-radius: var(--radius-md); 
        margin-top: 8px; 
        cursor: pointer; 
    }
    .message-content a { 
        display: block; 
        margin-top: 8px; 
        padding: 8px; 
        background-color: rgba(255,255,255,0.05); 
        border-radius: var(--radius-sm); 
        color: inherit; 
        text-decoration: none; 
        font-weight: 500; 
    }
    
    .translation-container { 
        margin-top: 10px; 
        padding-top: 10px; 
        border-top: 1px solid rgba(255,255,255,0.1); 
        font-style: italic; 
        opacity: 0.8; 
    }
    .message-bubble.theirs .translation-container { 
        border-top-color: rgba(255,255,255,0.1); 
    }
    
    .message-meta { 
        display: flex; 
        align-items: center; 
        justify-content: flex-end; 
        margin-top: 8px; 
        gap: 8px; 
    }
    .translate-btn { 
        background: none; 
        border: none; 
        cursor: pointer; 
        padding: 2px; 
        color: var(--text-tertiary);
    }
    .translate-btn:disabled { 
        opacity: 0.3; 
        cursor: not-allowed; 
    }
    .message-bubble.mine .translate-btn { 
        color: rgba(255,255,255,0.7); 
    }

    .message-form { 
        display: flex; 
        padding: 16px 24px; 
        border-top: 1px solid var(--border-color); 
        gap: 12px; 
        align-items: center; 
    }
    .file-input-label { 
        cursor: pointer; 
        padding: 8px; 
        border-radius: 50%; 
        transition: background-color 0.2s ease; 
        color: var(--text-secondary);
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .file-input-label:hover { 
        background-color: var(--bg-tertiary); 
    }
    #file-input { 
        display: none; 
    }

    .message-input { 
        flex-grow: 1; 
        border: none; 
        background-color: var(--bg-input); 
        border-radius: var(--radius-md); 
        padding: 12px 16px; 
        font-size: 1rem; 
        color: var(--text-primary); 
    }
    .message-input::placeholder { 
        color: var(--text-tertiary); 
    }
    .message-input:focus { 
        outline: 2px solid var(--accent-purple); 
    }
    .send-btn { 
        background-color: var(--accent-purple); 
        border: none; 
        border-radius: var(--radius-md); 
        padding: 12px; 
        cursor: pointer; 
        transition: background-color 0.2s ease; 
        color: white;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .send-btn:hover:not(:disabled) { 
        background-color: var(--accent-purple-darker); 
    }
    .message-form :disabled { 
        cursor: not-allowed; 
        opacity: 0.5; 
    }

    /* --- Modals & Overlays --- */
    .modal-backdrop {
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100vw; 
        height: 100vh;
        background-color: rgba(17, 24, 39, 0.6);
        backdrop-filter: blur(8px);
        display: flex; 
        align-items: center; 
        justify-content: center; 
        z-index: 1000;
        opacity: 0; 
        visibility: hidden; 
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-backdrop.visible { 
        opacity: 1; 
        visibility: visible; 
    }
    .modal {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        width: 90%; 
        max-width: 400px;
        transform: scale(0.95); 
        transition: transform 0.3s ease; 
        overflow: hidden;
    }
    .modal-backdrop.visible .modal { 
        transform: scale(1); 
    }
    .modal-header { 
        padding: 20px 24px; 
        border-bottom: 1px solid var(--border-color); 
    }
    .modal-title { 
        font-size: 1.25rem; 
        font-weight: 600; 
        color: var(--text-primary); 
    }
    .modal-body { 
        padding: 24px; 
    }
    .form-group { 
        margin-bottom: 16px; 
    }
    .form-group label { 
        display: block; 
        font-weight: 500; 
        margin-bottom: 8px; 
        color: var(--text-primary); 
    }
    .form-group input { 
        width: 100%; 
        border: 1px solid var(--border-color); 
        background-color: var(--bg-input); 
        border-radius: var(--radius-md); 
        padding: 12px 16px; 
        font-size: 1rem; 
        color: var(--text-primary); 
    }
    .form-group input:focus { 
        outline: 2px solid var(--accent-purple); 
        border-color: transparent; 
    }
    .modal-footer { 
        display: flex; 
        justify-content: flex-end; 
        padding: 16px 24px; 
        background-color: var(--bg-primary); 
    }
    .modal-btn { 
        padding: 10px 20px; 
        border-radius: var(--radius-md); 
        border: none; 
        font-weight: 600; 
        cursor: pointer; 
        transition: background-color 0.2s ease; 
        background-color: var(--bg-tertiary); 
        color: var(--text-primary); 
    }
    .modal-btn:hover { 
        background-color: #4B5563; 
    }
    .primary-btn { 
        background-color: var(--accent-purple); 
        color: white; 
    }
    .primary-btn:hover { 
        background-color: var(--accent-purple-darker); 
    }

    #qr-code-container { 
        display: flex; 
        justify-content: center; 
        margin-bottom: 20px; 
        padding: 16px; 
        background: white; 
        border-radius: var(--radius-md); 
    }
    #qr-code-canvas { 
        display: block; 
        max-width: 100%; 
        height: auto; 
    }

    /* Settings Modal */
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-top: 16px;
    }
    
    .setting-card {
        background-color: var(--bg-tertiary);
        border-radius: var(--radius-md);
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .setting-card:hover {
        background-color: var(--accent-purple);
        transform: translateY(-2px);
    }
    
    .setting-card i {
        font-size: 2rem;
        margin-bottom: 12px;
    }
    
    .setting-card h4 {
        font-size: 1rem;
        margin-bottom: 8px;
        color: var(--text-primary);
    }
    
    .setting-card p {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
    
    .setting-card.active {
        background-color: var(--accent-purple);
        border: 2px solid var(--accent-purple-darker);
    }
    
    /* Password Settings */
    .password-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 16px;
    }
    
    .password-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: var(--radius-md);
        background-color: var(--bg-tertiary);
        cursor: pointer;
    }
    
    .password-option.active {
        background-color: var(--accent-purple);
    }
    
    .password-option i {
        font-size: 1.2rem;
    }
    
    /* Pattern Grid */
    .pattern-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 20px auto;
        max-width: 250px;
    }
    
    .pattern-dot {
        width: 60px;
        height: 60px;
        background-color: var(--bg-tertiary);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .pattern-dot.selected {
        background-color: var(--accent-purple);
    }
    
    .pattern-dot.selected::after {
        content: "";
        width: 20px;
        height: 20px;
        background-color: white;
        border-radius: 50%;
    }
    
    /* PIN Input */
    .pin-input-container {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin: 20px 0;
    }
    
    .pin-input {
        width: 50px;
        height: 50px;
        text-align: center;
        font-size: 1.5rem;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-sm);
        background-color: var(--bg-input);
        color: var(--text-primary);
    }
    
    .pin-input:focus {
        outline: 2px solid var(--accent-purple);
        border-color: transparent;
    }
    
    /* Password Input */
    .password-input-container {
        position: relative;
        margin: 20px 0;
    }
    
    .password-input {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        background-color: var(--bg-input);
        color: var(--text-primary);
        font-size: 1rem;
    }
    
    .toggle-password {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
    }
    
    /* Lock Screen */
    .lock-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-primary);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-primary);
        text-align: center;
        padding: 20px;
    }
    
    .lock-screen i {
        font-size: 4rem;
        color: var(--accent-purple);
        margin-bottom: 20px;
    }
    
    .lock-screen h2 {
        font-size: 1.8rem;
        margin-bottom: 10px;
    }
    
    .lock-screen p {
        margin-bottom: 30px;
        color: var(--text-secondary);
        max-width: 300px;
    }
    
    .unlock-btn {
        background-color: var(--accent-purple);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: var(--radius-md);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .unlock-btn:hover {
        background-color: var(--accent-purple-darker);
    }

    /* --- Toast Notifications --- */
    .toast-container { 
        position: fixed; 
        bottom: 20px; 
        left: 50%; 
        transform: translateX(-50%); 
        z-index: 2000; 
        display: flex; 
        flex-direction: column; 
        gap: 10px; 
        align-items: center; 
    }
    .toast { 
        background-color: var(--bg-tertiary); 
        color: var(--text-primary); 
        padding: 12px 20px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-medium); 
        opacity: 0; 
        transform: translateY(20px); 
        animation: toast-in 0.3s ease forwards; 
    }
    @keyframes toast-in { 
        to { 
            opacity: 1; 
            transform: translateY(0); 
        } 
    }
    @keyframes toast-out { 
        to { 
            opacity: 0; 
            transform: translateY(20px); 
        } 
    }

    /* --- Call UI --- */
    .call-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(0,0,0,0.9); 
        z-index: 1500; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        opacity: 0; 
        visibility: hidden; 
        transition: opacity 0.3s ease; 
    }
    .call-overlay.visible { 
        opacity: 1; 
        visibility: visible; 
    }
    #remote-video { 
        width: 100%; 
        height: 100%; 
        object-fit: contain; 
    }
    #local-video { 
        position: absolute; 
        bottom: 100px; 
        right: 20px; 
        width: 200px; 
        height: 150px; 
        border-radius: var(--radius-md); 
        border: 2px solid rgba(255,255,255,0.5); 
        box-shadow: var(--shadow-lg); 
        object-fit: cover; 
    }
    .call-controls { 
        position: absolute; 
        bottom: 20px; 
        left: 50%; 
        transform: translateX(-50%); 
        display: flex; 
        gap: 16px; 
        background-color: rgba(0,0,0,0.3); 
        backdrop-filter: blur(10px); 
        padding: 12px 24px; 
        border-radius: 50px; 
    }
    .call-control-btn { 
        background-color: rgba(255,255,255,0.1); 
        border: none; 
        width: 56px; 
        height: 56px; 
        border-radius: 50%; 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        transition: background-color 0.2s ease; 
        color: white;
        font-size: 1.5rem;
    }
    .call-control-btn:hover { 
        background-color: rgba(255,255,255,0.2); 
    }
    .call-control-btn.hang-up { 
        background-color: #EF4444; 
    }
    .call-control-btn.hang-up:hover { 
        background-color: #DC2626; 
    }
    .call-control-btn.off { 
        background-color: #4B5563; 
    }

    /* Incoming Call Notification */
    .incoming-call-notification {
        position: fixed; 
        top: 20px; 
        right: 20px;
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 20px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-lg);
        z-index: 1600; 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        align-items: center;
        transform: translateX(120%); 
        transition: transform 0.4s ease-in-out;
    }
    .incoming-call-notification.visible { 
        transform: translateX(0); 
    }
    .incoming-call-actions { 
        display: flex; 
        gap: 12px; 
    }
    .incoming-call-btn { 
        padding: 12px; 
        border-radius: 50%; 
        border: none; 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 1.2rem;
        color: white;
    }
    #accept-call-btn { 
        background-color: var(--success-green); 
    }
    #decline-call-btn { 
        background-color: var(--error-red); 
    }

    /* Animations */
    @keyframes fadeInSlideUp {
        from { 
            opacity: 0; 
            transform: translateY(10px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }
    
    /* Responsiveness */
    @media (max-width: 768px) {
        .app-container.sidebar-hidden .sidebar { 
            transform: translateX(-100%); 
        }
        .sidebar { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 500;
            box-shadow: var(--shadow-lg);
        }
        .app-container:not(.sidebar-hidden) .sidebar-close-btn {
            display: block;
        }
        .hamburger-menu { 
            display: block; 
        }
        
        .settings-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>
<body oncontextmenu="return false;">

    <!-- Lock Screen -->
    <div class="lock-screen" id="lock-screen" style="display: none;">
        <i class="fas fa-lock"></i>
        <h2>AetherLocked</h2>
        <p id="lock-screen-message">Enter your passcode to continue</p>
        
        <!-- PIN Input for Lock Screen -->
        <div class="pin-input-container" id="lock-pin-container" style="display: none;">
            <input type="password" class="pin-input" maxlength="1" inputmode="numeric" pattern="\d*">
            <input type="password" class="pin-input" maxlength="1" inputmode="numeric" pattern="\d*">
            <input type="password" class="pin-input" maxlength="1" inputmode="numeric" pattern="\d*">
            <input type="password" class="pin-input" maxlength="1" inputmode="numeric" pattern="\d*">
        </div>
        
        <!-- Pattern Grid for Lock Screen -->
        <div id="lock-pattern-container" class="pattern-grid" style="display: none;">
            <div class="pattern-dot" data-dot="1"></div>
            <div class="pattern-dot" data-dot="2"></div>
            <div class="pattern-dot" data-dot="3"></div>
            <div class="pattern-dot" data-dot="4"></div>
            <div class="pattern-dot" data-dot="5"></div>
            <div class="pattern-dot" data-dot="6"></div>
            <div class="pattern-dot" data-dot="7"></div>
            <div class="pattern-dot" data-dot="8"></div>
            <div class="pattern-dot" data-dot="9"></div>
        </div>
        <p id="lock-pattern-instructions" style="display: none; color: var(--text-secondary); margin-top: 20px;">Draw your pattern</p>

        <!-- Password Input for Lock Screen -->
        <div class="password-input-container" id="lock-password-container" style="display: none;">
            <input type="password" class="password-input" id="lock-password-input" placeholder="Enter your password">
            <button class="toggle-password" id="lock-toggle-password">
                <i class="fas fa-eye"></i>
            </button>
        </div>
        
        <button class="unlock-btn" id="unlock-btn">Unlock</button>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="app-container sidebar-hidden">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span class="logo-text">AetherLink</span>
                </div>
                <div class="sidebar-header-actions">
                    <button class="add-contact-btn sidebar-close-btn" id="sidebar-close-btn" title="Close Sidebar">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="add-contact-btn" id="settings-btn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="add-contact-btn" id="add-contact-btn-main">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>
            <ul class="contact-list" id="contact-list"></ul>
            <div class="sidebar-footer">
                <div class="your-id-header">
                    <span class="your-id-title">Your ID</span>
                    <div class="your-id-actions">
                        <button class="id-action-btn" id="copy-id-btn" title="Copy ID">
                            <i class="far fa-copy"></i>
                        </button>
                        <button class="id-action-btn" id="share-id-btn" title="Share ID">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="your-id-display" id="your-id-display">Initializing...</div>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area">
            <div class="chat-header">
                <button class="hamburger-menu" id="hamburger-menu" aria-label="Guide" aria-pressed="false">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="chat-contact-info">
                    <div class="chat-contact-name" id="chat-contact-name">Select a contact</div>
                    <div class="chat-contact-status" id="chat-contact-status"></div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn ghost-mode-toggle" id="ghost-mode-toggle">
                        <i class="fas fa-ghost"></i> Ghost
                    </button>
                    <button class="chat-action-btn" id="voice-call-btn" title="Voice Call" disabled>
                        <i class="fas fa-phone-alt"></i>
                    </button>
                    <button class="chat-action-btn" id="video-call-btn" title="Video Call" disabled>
                        <i class="fas fa-video"></i>
                    </button>
                </div>
            </div>
            <div class="message-list" id="message-list">
                <div class="empty-chat" id="empty-chat-screen">
                    <div class="empty-chat-logo">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h2>Welcome to AetherLink</h2>
                    <p>Select a contact to start a secure, end-to-end encrypted conversation.</p>
                </div>
            </div>
            <form class="message-form" id="message-form">
                <label for="file-input" class="file-input-label">
                    <i class="fas fa-paperclip"></i>
                </label>
                <input type="file" id="file-input" disabled>
                <input type="text" class="message-input" id="message-input" placeholder="Type a message..." autocomplete="off" disabled>
                <button type="submit" class="send-btn" id="send-btn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-backdrop" id="add-contact-modal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Add New Contact</h3></div>
            <div class="modal-body">
                <form id="add-contact-form">
                    <div class="form-group">
                        <label for="contact-name-input">Contact Name</label>
                        <input type="text" id="contact-name-input" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-id-input">Peer ID</label>
                        <input type="text" id="contact-id-input" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="cancel-add-contact-btn">Cancel</button>
                <button class="modal-btn primary-btn" id="save-contact-btn">Save</button>
            </div>
        </div>
    </div>
    
    <div class="modal-backdrop" id="share-id-modal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Share Your ID</h3></div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-secondary); text-align: center;">Share this magic link or QR code to connect.</p>
                <div id="qr-code-container">
                    <canvas id="qr-code-canvas"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                 <button class="modal-btn" id="cancel-share-btn">Close</button>
                <button class="modal-btn primary-btn" id="share-link-btn">Share Link</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-backdrop" id="settings-modal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Settings</h3></div>
            <div class="modal-body">
                <h4>Appearance</h4>
                <div class="settings-grid">
                    <div class="setting-card" data-theme="default">
                        <i class="fas fa-moon"></i>
                        <h4>Midnight</h4>
                        <p>Default dark theme</p>
                    </div>
                    <div class="setting-card" data-theme="ocean-blue">
                        <i class="fas fa-water"></i>
                        <h4>Ocean Blue</h4>
                        <p>Deep blue tones</p>
                    </div>
                    <div class="setting-card" data-theme="forest-green">
                        <i class="fas fa-tree"></i>
                        <h4>Forest Green</h4>
                        <p>Nature-inspired</p>
                    </div>
                    <div class="setting-card" data-theme="sunset-orange">
                        <i class="fas fa-sun"></i>
                        <h4>Sunset Orange</h4>
                        <p>Warm orange tones</p>
                    </div>
                    <div class="setting-card" data-theme="royal-purple">
                        <i class="fas fa-crown"></i>
                        <h4>Royal Purple</h4>
                        <p>Regal purple theme</p>
                    </div>
                </div>
                
                <h4 style="margin-top: 24px;">Security</h4>
                <div class="password-options">
                    <div class="password-option" data-type="pin">
                        <i class="fas fa-lock"></i>
                        <div>
                            <h4>PIN Protection</h4>
                            <p>Set a 4-digit PIN to lock the app</p>
                        </div>
                    </div>
                    <div class="password-option" data-type="pattern">
                        <i class="fas fa-draw-polygon"></i>
                        <div>
                            <h4>Pattern Lock</h4>
                            <p>Create a pattern to unlock the app</p>
                        </div>
                    </div>
                    <div class="password-option" data-type="password">
                        <i class="fas fa-key"></i>
                        <div>
                            <h4>Password Lock</h4>
                            <p>Set a text password to secure the app</p>
                        </div>
                    </div>
                </div>
                
                <!-- PIN Setup -->
                <div id="pin-setup" style="display: none; margin-top: 20px;">
                    <h4>Set PIN</h4>
                    <div class="pin-input-container">
                        <input type="password" class="pin-input" maxlength="1" inputmode="numeric" pattern="\d*">
                        <input type="password" class="pin-input" maxlength="1" inputmode="numeric" pattern="\d*">
                        <input type="password" class="pin-input" maxlength="1" inputmode="numeric" pattern="\d*">
                        <input type="password" class="pin-input" maxlength="1" inputmode="numeric" pattern="\d*">
                    </div>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                        <button class="modal-btn" id="cancel-pin-btn">Cancel</button>
                        <button class="modal-btn primary-btn" id="save-pin-btn">Save</button>
                    </div>
                </div>
                
                <!-- Pattern Setup -->
                <div id="pattern-setup" style="display: none; margin-top: 20px;">
                    <h4>Set Pattern</h4>
                    <div class="pattern-grid">
                        <div class="pattern-dot" data-dot="1"></div>
                        <div class="pattern-dot" data-dot="2"></div>
                        <div class="pattern-dot" data-dot="3"></div>
                        <div class="pattern-dot" data-dot="4"></div>
                        <div class="pattern-dot" data-dot="5"></div>
                        <div class="pattern-dot" data-dot="6"></div>
                        <div class="pattern-dot" data-dot="7"></div>
                        <div class="pattern-dot" data-dot="8"></div>
                        <div class="pattern-dot" data-dot="9"></div>
                    </div>
                    <p id="pattern-instructions">Draw your pattern by connecting at least 4 dots</p>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                        <button class="modal-btn" id="cancel-pattern-btn">Cancel</button>
                        <button class="modal-btn primary-btn" id="save-pattern-btn">Save</button>
                    </div>
                </div>
                
                <!-- Password Setup -->
                <div id="password-setup" style="display: none; margin-top: 20px;">
                    <h4>Set Password</h4>
                    <div class="password-input-container">
                        <input type="password" class="password-input" id="password-input" placeholder="Enter your password">
                        <button class="toggle-password" id="toggle-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="password-input-container">
                        <input type="password" class="password-input" id="confirm-password-input" placeholder="Confirm password">
                    </div>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                        <button class="modal-btn" id="cancel-password-btn">Cancel</button>
                        <button class="modal-btn primary-btn" id="save-password-btn">Save</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="cancel-settings-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Call UI -->
    <div class="call-overlay" id="call-overlay">
        <video id="remote-video" autoplay></video>
        <video id="local-video" autoplay muted></video>
        <div class="call-controls">
            <button class="call-control-btn" id="toggle-mic-btn" title="Mute/Unmute Mic">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="call-control-btn" id="toggle-cam-btn" title="Turn Camera On/Off">
                <i class="fas fa-video"></i>
            </button>
            <button class="call-control-btn hang-up" id="hang-up-btn" title="Hang Up">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>
    
    <div class="incoming-call-notification" id="incoming-call-notification">
        <p id="incoming-call-text">Incoming call...</p>
        <div class="incoming-call-actions">
            <button class="incoming-call-btn" id="decline-call-btn" title="Decline">
                <i class="fas fa-phone-slash"></i>
            </button>
            <button class="incoming-call-btn" id="accept-call-btn" title="Accept">
                <i class="fas fa-phone-alt"></i>
            </button>
        </div>
    </div>


    <script>
    const App = {
        // State
        peer: null,
        myPeerId: null,
        currentConnection: null,
        activePeerId: null,
        sharedSecrets: new Map(),
        keyPair: null,
        contacts: [],
        ghostMode: false,
        currentCall: null,
        localStream: null,
        incomingCall: null,
        securityType: null, // 'pin', 'pattern', 'password'
        securityValue: null,
        currentTheme: 'default',
        selectedPattern: [], // For setting the pattern in settings modal
        lockScreenEnteredPattern: [], // NEW: For entering pattern on lock screen

        // DOM Elements
        dom: {},

        // Initialization
        init() {
            this.cacheDom();
            this.bindEventListeners();
            this.hardenApplication();
            this.loadSettings(); // Loads theme and securityType/Value
            this.loadContacts();
            this.renderContacts();
            this.updateChatUIForNoSelection();
            this.generateKeys().then(() => {
                this.initializePeer();
            });
            
            // Mobile sidebar handling
            if (window.innerWidth <= 768) {
                this.dom.appContainer.classList.add('sidebar-hidden');
            } else {
                 this.dom.appContainer.classList.remove('sidebar-hidden');
            }
            
            // Apply security if enabled
            if (this.securityType && this.securityValue) {
                this.showLockScreen();
            }
        },

        cacheDom() {
            this.dom = {
                appContainer: document.getElementById('app-container'),
                sidebar: document.querySelector('.sidebar'),
                sidebarCloseBtn: document.getElementById('sidebar-close-btn'), 
                hamburgerMenu: document.getElementById('hamburger-menu'),
                addContactBtn: document.getElementById('add-contact-btn-main'),
                contactList: document.getElementById('contact-list'),
                yourIdDisplay: document.getElementById('your-id-display'),
                copyIdBtn: document.getElementById('copy-id-btn'),
                shareIdBtn: document.getElementById('share-id-btn'),
                chatContactName: document.getElementById('chat-contact-name'),
                chatContactStatus: document.getElementById('chat-contact-status'),
                messageList: document.getElementById('message-list'),
                emptyChatScreen: document.getElementById('empty-chat-screen'),
                messageForm: document.getElementById('message-form'),
                messageInput: document.getElementById('message-input'),
                sendBtn: document.getElementById('send-btn'),
                fileInput: document.getElementById('file-input'),
                ghostModeToggle: document.getElementById('ghost-mode-toggle'),
                voiceCallBtn: document.getElementById('voice-call-btn'),
                videoCallBtn: document.getElementById('video-call-btn'),
                addContactModal: document.getElementById('add-contact-modal'),
                contactNameInput: document.getElementById('contact-name-input'),
                contactIdInput: document.getElementById('contact-id-input'),
                saveContactBtn: document.getElementById('save-contact-btn'),
                cancelAddContactBtn: document.getElementById('cancel-add-contact-btn'),
                shareIdModal: document.getElementById('share-id-modal'),
                qrCodeCanvas: document.getElementById('qr-code-canvas'), 
                shareLinkBtn: document.getElementById('share-link-btn'),
                cancelShareBtn: document.getElementById('cancel-share-btn'),
                toastContainer: document.getElementById('toast-container'),
                callOverlay: document.getElementById('call-overlay'),
                remoteVideo: document.getElementById('remote-video'),
                localVideo: document.getElementById('local-video'),
                toggleMicBtn: document.getElementById('toggle-mic-btn'),
                toggleCamBtn: document.getElementById('toggle-cam-btn'),
                hangUpBtn: document.getElementById('hang-up-btn'),
                incomingCallNotification: document.getElementById('incoming-call-notification'),
                incomingCallText: document.getElementById('incoming-call-text'),
                acceptCallBtn: document.getElementById('accept-call-btn'),
                declineCallBtn: document.getElementById('decline-call-btn'),
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'),
                cancelSettingsBtn: document.getElementById('cancel-settings-btn'),
                lockScreen: document.getElementById('lock-screen'),
                unlockBtn: document.getElementById('unlock-btn'),
                
                // NEW: Lock screen specific elements
                lockScreenMessage: document.getElementById('lock-screen-message'),
                lockPinContainer: document.getElementById('lock-pin-container'),
                lockPinInputs: document.querySelectorAll('#lock-pin-container .pin-input'),
                lockPatternContainer: document.getElementById('lock-pattern-container'),
                lockPatternDots: document.querySelectorAll('#lock-pattern-container .pattern-dot'),
                lockPatternInstructions: document.getElementById('lock-pattern-instructions'),
                lockPasswordContainer: document.getElementById('lock-password-container'),
                lockPasswordInput: document.getElementById('lock-password-input'),
                lockTogglePasswordBtn: document.getElementById('lock-toggle-password'),

                // Settings modal elements (already existing)
                pinInputs: document.querySelectorAll('#pin-setup .pin-input'), // Original PIN inputs in settings
                patternDots: document.querySelectorAll('#pattern-setup .pattern-dot'), // Original pattern dots in settings
                patternInstructions: document.getElementById('pattern-instructions'), // Instructions in settings
                passwordInput: document.getElementById('password-input'), // Original password input in settings
                confirmPasswordInput: document.getElementById('confirm-password-input'), // Original confirm password in settings
                togglePasswordBtn: document.getElementById('toggle-password'), // Original password toggle in settings
                settingCards: document.querySelectorAll('.setting-card'),
                passwordOptions: document.querySelectorAll('.password-option'),
                pinSetup: document.getElementById('pin-setup'),
                patternSetup: document.getElementById('pattern-setup'),
                passwordSetup: document.getElementById('password-setup'),
                savePinBtn: document.getElementById('save-pin-btn'),
                cancelPinBtn: document.getElementById('cancel-pin-btn'),
                savePatternBtn: document.getElementById('save-pattern-btn'),
                cancelPatternBtn: document.getElementById('cancel-pattern-btn'),
                savePasswordBtn: document.getElementById('save-password-btn'),
                cancelPasswordBtn: document.getElementById('cancel-password-btn')
            };
        },

        // Security & Hardening
        hardenApplication() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F12' ||
                    (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) ||
                    (e.metaKey && e.altKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) ||
                    (e.ctrlKey && e.key.toUpperCase() === 'U') ||
                    (e.ctrlKey && e.key.toUpperCase() === 'S')) {
                    e.preventDefault();
                }
            });
        },
        
        // E2EE Cryptography
        async generateKeys() {
            this.keyPair = await window.crypto.subtle.generateKey(
                { name: 'ECDH', namedCurve: 'P-384' },
                true,
                ['deriveKey']
            );
        },

        async deriveSharedSecret(peerPublicKeyJwk) {
            const peerPublicKey = await window.crypto.subtle.importKey(
                'jwk',
                peerPublicKeyJwk,
                { name: 'ECDH', namedCurve: 'P-384' },
                true,
                []
            );
            return await window.crypto.subtle.deriveKey(
                { name: 'ECDH', public: peerPublicKey },
                this.keyPair.privateKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        },

        async encryptMessage(text, peerId) {
            const sharedSecret = this.sharedSecrets.get(peerId);
            if (!sharedSecret) throw new Error('No shared secret for this peer.');
            
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encodedText = new TextEncoder().encode(text);
            
            const encryptedData = await window.crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                sharedSecret,
                encodedText
            );
            
            return {
                iv: Array.from(iv),
                data: Array.from(new Uint8Array(encryptedData))
            };
        },

        async decryptMessage(encryptedPayload, peerId) {
            const sharedSecret = this.sharedSecrets.get(peerId);
            if (!sharedSecret) throw new Error('No shared secret for this peer.');

            const iv = new Uint8Array(encryptedPayload.iv);
            const data = new Uint8Array(encryptedPayload.data);

            const decryptedData = await window.crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                sharedSecret,
                data
            );
            
            return new TextDecoder().decode(decryptedData);
        },

        // PeerJS & Connection Management
        initializePeer() {
            this.peer = new Peer();

            this.peer.on('open', (id) => {
                this.myPeerId = id;
                this.dom.yourIdDisplay.textContent = id;
                this.handleMagicLink();
                console.log('PeerJS ID obtained:', id); // For debugging ID display
            });

            this.peer.on('connection', (conn) => {
                this.handleNewConnection(conn);
            });
            
            this.peer.on('call', (call) => {
                this.handleIncomingCall(call);
            });
            
            this.peer.on('error', (err) => {
                console.error('PeerJS Error:', err);
                this.showToast(`Error: ${err.type}`, 'error');
                if (err.type === 'peer-unavailable' && this.activePeerId) {
                    this.updateConnectionStatusUI('Disconnected');
                    this.addSystemMessage(`${this.getContactName(this.activePeerId)} is unavailable.`);
                    this.setChatInputEnabled(false);
                }
            });
        },

        connectToPeer(peerId) {
            if (this.currentConnection) {
                this.currentConnection.close();
            }
            this.updateConnectionStatusUI('Connecting...');
            
            const conn = this.peer.connect(peerId, { reliable: true });
            this.handleNewConnection(conn);
        },

        async handleNewConnection(conn) {
            conn.on('open', async () => {
                this.currentConnection = conn;
                this.activePeerId = conn.peer;

                // Start Handshake
                const publicKeyJwk = await window.crypto.subtle.exportKey('jwk', this.keyPair.publicKey);
                conn.send({ type: 'handshake', publicKey: publicKeyJwk });
                
                this.updateChatUIForActiveConnection(conn.peer);
            });

            conn.on('data', (data) => this.handleData(conn, data));

            conn.on('close', () => {
                if (this.currentConnection && this.currentConnection.peer === conn.peer) {
                    this.addSystemMessage(`Connection to ${this.getContactName(conn.peer)} closed.`);
                    this.updateConnectionStatusUI('Disconnected');
                    this.setChatInputEnabled(false);
                    this.currentConnection = null;
                    this.activePeerId = null;
                }
            });
        },

        async handleData(conn, data) {
            try {
                switch(data.type) {
                    case 'handshake': {
                        const sharedSecret = await this.deriveSharedSecret(data.publicKey);
                        this.sharedSecrets.set(conn.peer, sharedSecret);
                        
                        const myPublicKeyJwk = await window.crypto.subtle.exportKey('jwk', this.keyPair.publicKey);
                        conn.send({ type: 'handshake-ack', publicKey: myPublicKeyJwk });
                        
                        this.updateConnectionStatusUI('Connected');
                        this.setChatInputEnabled(true);
                        this.addSystemMessage(`Connection with ${this.getContactName(conn.peer)} is now secure.`);
                        break;
                    }
                    case 'handshake-ack': {
                        const sharedSecret = await this.deriveSharedSecret(data.publicKey);
                        this.sharedSecrets.set(conn.peer, sharedSecret);

                        this.updateConnectionStatusUI('Connected');
                        this.setChatInputEnabled(true);
                        this.addSystemMessage(`Connection with ${this.getContactName(conn.peer)} is now secure.`);
                        break;
                    }
                    case 'encrypted-message': {
                        const decrypted = await this.decryptMessage(data.payload, conn.peer);
                        const messageData = JSON.parse(decrypted);
                        this.addMessageToUI(messageData.content, 'theirs', this.getContactName(conn.peer), messageData.isImage, messageData.fileName);
                        break;
                    }
                }
            } catch (error) {
                console.error("Data handling error:", error);
                this.addSystemMessage("An error occurred while processing a message.");
            }
        },

        // UI & UX Methods
        showModal(modal) {
            modal.classList.add('visible');
        },
        
        hideModal(modal) {
            modal.classList.remove('visible');
        },
        
        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            if (type === 'success') toast.style.backgroundColor = 'var(--success-green)';
            if (type === 'error') toast.style.backgroundColor = 'var(--error-red)';
            if (type === 'warning') toast.style.backgroundColor = 'var(--warning-yellow)';


            this.dom.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toast-out 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        },

        renderContacts() {
            this.dom.contactList.innerHTML = '';
            
            // Separate pinned and unpinned contacts
            const pinnedContacts = this.contacts.filter(c => c.pinned);
            const unpinnedContacts = this.contacts.filter(c => !c.pinned);
            
            // Render pinned contacts first
            pinnedContacts.forEach((contact, index) => {
                this.renderContactItem(contact, index, true);
            });
            
            // Render unpinned contacts
            unpinnedContacts.forEach((contact, index) => {
                this.renderContactItem(contact, index + pinnedContacts.length, false);
            });
        },
        
        renderContactItem(contact, index, isPinned) {
            const li = document.createElement('li');
            li.className = `contact-item ${isPinned ? 'pinned' : ''}`;
            li.dataset.peerId = contact.peerId;
            
            if(contact.peerId === this.activePeerId) {
                li.classList.add('active');
            }
            
            li.style.animationDelay = `${index * 50}ms`;
            li.innerHTML = `
                <span class="contact-name">${contact.name}</span>
                <div class="contact-actions">
                    <button class="contact-action-btn pin-contact-btn" data-peer-id="${contact.peerId}" title="${contact.pinned ? 'Unpin' : 'Pin'}">
                        <i class="fas fa-thumbtack ${contact.pinned ? 'active' : ''}"></i>
                    </button>
                    <button class="contact-action-btn delete-contact-btn" data-peer-id="${contact.peerId}" title="Delete Contact">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            this.dom.contactList.appendChild(li);
        },

        addMessageToUI(content, type, senderName, isImage = false, fileName = '') {
            this.dom.emptyChatScreen.style.display = 'none';
            const item = document.createElement('div');
            item.className = `message-item ${type}`;
            
            let messageContentHTML;
            if (isImage) {
                messageContentHTML = `<img src="${content}" alt="Image from ${senderName}">`;
            } else if (fileName) {
                 const blob = this.dataURItoBlob(content);
                 const url = URL.createObjectURL(blob);
                 messageContentHTML = `<a href="${url}" download="${fileName}">Download: ${fileName}</a>`;
            } else {
                messageContentHTML = content.replace(/\n/g, '<br>');
            }

            const metaHTML = type === 'theirs'
                ? `<div class="message-meta">
                       <button class="translate-btn" title="Translate">
                           <i class="fas fa-language"></i>
                       </button>
                   </div>`
                : '';
                
            item.innerHTML = `
                <div class="message-bubble ${type}">
                    <div class="message-content">${messageContentHTML}</div>
                    ${metaHTML}
                </div>
            `;
            this.dom.messageList.appendChild(item);

            // Ephemeral Messages
            const timeoutDuration = this.ghostMode ? 30 * 1000 : 2 * 60 * 1000;
            setTimeout(() => {
                item.classList.add('disappearing');
                setTimeout(() => item.remove(), 500);
            }, timeoutDuration);

            this.dom.messageList.scrollTop = this.dom.messageList.scrollHeight;
        },

        addSystemMessage(text) {
            this.addMessageToUI(text, 'system');
        },

        updateChatUIForNoSelection() {
            this.dom.chatContactName.textContent = 'Select a contact';
            this.dom.chatContactStatus.textContent = '';
            this.dom.chatContactStatus.className = 'chat-contact-status';
            this.dom.messageList.innerHTML = '';
            this.dom.emptyChatScreen.style.display = 'flex';
            this.setChatInputEnabled(false);
        },

        updateChatUIForActiveConnection(peerId) {
            const contact = this.getContactByPeerId(peerId);
            this.dom.chatContactName.textContent = contact ? contact.name : peerId;
            this.dom.messageList.innerHTML = '';
            this.dom.emptyChatScreen.style.display = 'none';
        },
        
        updateConnectionStatusUI(status) {
            this.dom.chatContactStatus.textContent = status;
            this.dom.chatContactStatus.className = 'chat-contact-status';
            if (status === 'Connected') this.dom.chatContactStatus.classList.add('connected');
            if (status === 'Disconnected') this.dom.chatContactStatus.classList.add('disconnected');
        },
        
        setChatInputEnabled(enabled) {
            this.dom.messageInput.disabled = !enabled;
            this.dom.sendBtn.disabled = !enabled;
            this.dom.fileInput.disabled = !enabled;
            this.dom.voiceCallBtn.disabled = !enabled;
            this.dom.videoCallBtn.disabled = !enabled;
        },
        
        // Call Logic
        async initiateCall(video = false) {
            try {
                this.localStream = await navigator.mediaDevices.getUserMedia({ 
                    video,
                    audio: true 
                });
                this.dom.localVideo.srcObject = this.localStream;
                this.currentCall = this.peer.call(this.activePeerId, this.localStream, {
                    metadata: { video }
                });
                this.showCallUI();
                this.setupCallListeners(this.currentCall);
            } catch (err) {
                console.error('Failed to get local stream', err);
                this.showToast('Could not access camera/mic.', 'error');
            }
        },

        handleIncomingCall(call) {
            this.incomingCall = call;
            const contactName = this.getContactName(call.peer);
            this.dom.incomingCallText.textContent = `Incoming ${call.metadata.video ? 'video' : 'voice'} call from ${contactName}`;
            this.dom.incomingCallNotification.classList.add('visible');
        },

        async answerCall() {
            try {
                this.dom.incomingCallNotification.classList.remove('visible');
                const video = this.incomingCall.metadata && this.incomingCall.metadata.video;
                this.localStream = await navigator.mediaDevices.getUserMedia({ 
                    video, 
                    audio: true 
                });
                this.dom.localVideo.srcObject = this.localStream;
                this.incomingCall.answer(this.localStream);
                this.currentCall = this.incomingCall;
                this.showCallUI();
                this.setupCallListeners(this.currentCall);
                this.incomingCall = null;
            } catch (err) {
                console.error('Failed to get local stream for answer', err);
                this.showToast('Could not access camera/mic.', 'error');
            }
        },
        
        declineCall() {
            if (this.incomingCall) {
                this.incomingCall.close();
                this.incomingCall = null;
            }
            this.dom.incomingCallNotification.classList.remove('visible');
        },

        setupCallListeners(call) {
            call.on('stream', (remoteStream) => {
                this.dom.remoteVideo.srcObject = remoteStream;
            });
            call.on('close', () => {
                this.endCall();
            });
            call.on('error', (err) => {
                console.error("Call error:", err);
                this.endCall();
                this.showToast("Call error occurred.", 'error');
            });
        },
        
        showCallUI() {
            this.dom.callOverlay.classList.add('visible');
            this.resetCallButtons();
        },
        
        endCall() {
            if (this.currentCall) {
                this.currentCall.close();
            }
            if (this.localStream) {
                this.localStream.getTracks().forEach(track => track.stop());
                this.localStream = null;
            }
            this.dom.callOverlay.classList.remove('visible');
            this.dom.remoteVideo.srcObject = null;
            this.dom.localVideo.srcObject = null;
            this.currentCall = null;
        },
        
        resetCallButtons() {
            this.dom.toggleMicBtn.classList.remove('off');
            this.dom.toggleCamBtn.classList.remove('off');
        },
        
        // Security & Settings
        loadSettings() {
            // Load theme
            const savedTheme = localStorage.getItem('aetherlink-theme');
            if (savedTheme) {
                this.currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', savedTheme);
                
                // Update active theme card - Needs to be done after cacheDom for initial load
                // This will happen once bindEventListeners is called, or we could add a method call
            }
            
            // Load security settings
            const securityType = localStorage.getItem('aetherlink-security-type');
            const securityValue = localStorage.getItem('aetherlink-security-value');
            
            if (securityType && securityValue) {
                this.securityType = securityType;
                this.securityValue = securityValue;
            }
        },
        
        saveSettings() {
            localStorage.setItem('aetherlink-theme', this.currentTheme);
            
            // Only save security if it's set
            if (this.securityType && this.securityValue) {
                localStorage.setItem('aetherlink-security-type', this.securityType);
                localStorage.setItem('aetherlink-security-value', this.securityValue);
            } else { // If security is being removed
                localStorage.removeItem('aetherlink-security-type');
                localStorage.removeItem('aetherlink-security-value');
            }
        },
        
        showLockScreen() {
            this.dom.appContainer.style.display = 'none'; // Hide main app
            this.dom.lockScreen.style.display = 'flex';

            // Hide all input containers first
            this.dom.lockPinContainer.style.display = 'none';
            this.dom.lockPatternContainer.style.display = 'none';
            this.dom.lockPatternInstructions.style.display = 'none'; // Also hide instructions
            this.dom.lockPasswordContainer.style.display = 'none';

            // Show and focus the correct input type
            if (this.securityType === 'pin') {
                this.dom.lockPinContainer.style.display = 'flex';
                this.dom.lockPinInputs.forEach(input => input.value = ''); // Clear inputs
                this.dom.lockPinInputs[0].focus();
                this.dom.lockScreenMessage.textContent = 'Enter your PIN to continue';
            } else if (this.securityType === 'pattern') {
                this.dom.lockPatternContainer.style.display = 'grid'; // Use 'grid' as it's a grid layout
                this.dom.lockPatternInstructions.style.display = 'block';
                this.dom.lockPatternInstructions.textContent = 'Draw your pattern to unlock';
                this.lockScreenEnteredPattern = []; // Initialize for unlock attempt
                this.dom.lockPatternDots.forEach(dot => dot.classList.remove('selected')); // Clear visual
                this.dom.lockScreenMessage.textContent = 'Draw your pattern to unlock';
            } else if (this.securityType === 'password') {
                this.dom.lockPasswordContainer.style.display = 'block';
                this.dom.lockPasswordInput.value = ''; // Clear input
                this.dom.lockPasswordInput.focus();
                this.dom.lockScreenMessage.textContent = 'Enter your password to continue';
            } else {
                // No security set, should not happen if called correctly
                this.hideLockScreen();
                this.dom.appContainer.style.display = 'flex'; // Show main app
                this.showToast('No security set. Access granted.', 'warning');
            }
        },
        
        hideLockScreen() {
            this.dom.lockScreen.style.display = 'none';
            this.dom.appContainer.style.display = 'flex'; // Show main app
        },
        
        validatePin() {
            let enteredPin = '';
            this.dom.lockPinInputs.forEach(input => { // Use lockPinInputs
                enteredPin += input.value;
            });
            return enteredPin === this.securityValue;
        },
        
        validatePattern() {
            // For demo purposes, we'll just compare arrays
            return this.lockScreenEnteredPattern.join('') === this.securityValue;
        },
        
        validatePassword() {
            return this.dom.lockPasswordInput.value === this.securityValue; // Use lockPasswordInput
        },

        // Event Handlers & Binding
        bindEventListeners() {
            // Sidebar
            this.dom.addContactBtn.addEventListener('click', () => {
                this.dom.contactNameInput.value = '';
                this.dom.contactIdInput.value = '';
                this.showModal(this.dom.addContactModal);
            });
            
            this.dom.sidebarCloseBtn.addEventListener('click', () => {
                this.dom.appContainer.classList.add('sidebar-hidden');
                // The hamburger menu state implicitly becomes false when sidebar is hidden
                this.dom.hamburgerMenu.setAttribute('aria-pressed', false);
            });
            
            this.dom.contactList.addEventListener('click', (e) => {
                const contactItem = e.target.closest('.contact-item');
                const deleteBtn = e.target.closest('.delete-contact-btn');
                const pinBtn = e.target.closest('.pin-contact-btn');

                if (deleteBtn) {
                    e.stopPropagation();
                    if (confirm(`Are you sure you want to delete this contact?`)) {
                        this.deleteContact(deleteBtn.dataset.peerId);
                    }
                    return;
                }
                
                if (pinBtn) {
                    e.stopPropagation();
                    this.togglePinContact(pinBtn.dataset.peerId);
                    return;
                }
                
                if (contactItem) {
                    const peerId = contactItem.dataset.peerId;
                    if(peerId === this.activePeerId && this.currentConnection) return;
                    
                    this.activePeerId = peerId;
                    this.renderContacts();
                    this.connectToPeer(peerId);
                    
                    if (window.innerWidth <= 768) {
                        this.dom.appContainer.classList.add('sidebar-hidden');
                        this.dom.hamburgerMenu.setAttribute('aria-pressed', false); // Hide sidebar means unpressed hamburger
                    }
                }
            });
            
            this.dom.copyIdBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(this.myPeerId)
                    .then(() => this.showToast('ID Copied!', 'success'))
                    .catch(err => this.showToast('Failed to copy ID.', 'error'));
            });
            
            this.dom.shareIdBtn.addEventListener('click', () => {
                const magicLink = `${location.href.split('#')[0]}#${this.myPeerId}`;
                const ctx = this.dom.qrCodeCanvas.getContext('2d');
                ctx.clearRect(0, 0, this.dom.qrCodeCanvas.width, this.dom.qrCodeCanvas.height);
                
                QRCode.toCanvas(this.dom.qrCodeCanvas, magicLink, {width: 256}, (error) => {
                    if (error) {
                        console.error("QR Code generation error:", error);
                        this.showToast('Failed to generate QR code.', 'error');
                    }
                });
                this.showModal(this.dom.shareIdModal);
            });

            // Chat Area
            this.dom.hamburgerMenu.addEventListener('click', () => {
                const isHiddenAfterToggle = this.dom.appContainer.classList.toggle('sidebar-hidden');
                this.dom.hamburgerMenu.setAttribute('aria-pressed', !isHiddenAfterToggle);
            });
            
            this.dom.messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.sendMessage();
            });
            
            this.dom.ghostModeToggle.addEventListener('click', () => {
                this.ghostMode = !this.ghostMode;
                this.dom.ghostModeToggle.classList.toggle('active', this.ghostMode);
                this.addSystemMessage(`Ghost mode is now ${this.ghostMode ? 'ON' : 'OFF'}. Messages will disappear faster.`);
            });
            
            this.dom.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(file) this.sendFile(file);
            });
            
            this.dom.messageList.addEventListener('click', (e) => {
                const translateBtn = e.target.closest('.translate-btn');
                if (translateBtn) {
                    this.handleTranslate(translateBtn);
                }
            });

            // Modals
            this.dom.saveContactBtn.addEventListener('click', () => this.saveContact());
            this.dom.cancelAddContactBtn.addEventListener('click', () => this.hideModal(this.dom.addContactModal));
            this.dom.addContactModal.addEventListener('click', (e) => {
                if(e.target === this.dom.addContactModal) this.hideModal(this.dom.addContactModal);
            });
            
            this.dom.shareLinkBtn.addEventListener('click', () => {
                const magicLink = `${location.href.split('#')[0]}#${this.myPeerId}`;
                if (navigator.share) {
                    navigator.share({
                        title: 'AetherLink Invitation',
                        text: 'Connect with me on AetherLink!',
                        url: magicLink,
                    }).catch(err => console.error("Share failed", err));
                } else {
                    navigator.clipboard.writeText(magicLink)
                        .then(() => this.showToast('Magic Link copied to clipboard!', 'success'))
                        .catch(err => this.showToast('Failed to copy link.', 'error'));
                }
            });
            
            this.dom.cancelShareBtn.addEventListener('click', () => this.hideModal(this.dom.shareIdModal));
            
            // Settings
            this.dom.settingsBtn.addEventListener('click', () => {
                this.showModal(this.dom.settingsModal);
                // Highlight active theme card
                this.dom.settingCards.forEach(card => {
                    card.classList.remove('active');
                    if (card.dataset.theme === this.currentTheme) {
                        card.classList.add('active');
                    }
                });
                // Highlight active security option
                this.dom.passwordOptions.forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.type === this.securityType) {
                        option.classList.add('active');
                    }
                });
                // Hide all security setup sections initially when opening settings modal
                this.dom.pinSetup.style.display = 'none';
                this.dom.patternSetup.style.display = 'none';
                this.dom.passwordSetup.style.display = 'none';
            });
            
            this.dom.cancelSettingsBtn.addEventListener('click', () => {
                this.hideModal(this.dom.settingsModal);
            });
            
            // Theme selection
            this.dom.settingCards.forEach(card => {
                card.addEventListener('click', () => {
                    const theme = card.dataset.theme;
                    this.currentTheme = theme;
                    document.documentElement.setAttribute('data-theme', theme);
                    this.saveSettings();
                    
                    // Update active state
                    this.dom.settingCards.forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    
                    this.showToast(`Theme changed to ${card.querySelector('h4').textContent}`, 'success');
                });
            });
            
            // Security options (in settings modal)
            this.dom.passwordOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const type = option.dataset.type;
                    
                    // Hide all setup forms
                    this.dom.pinSetup.style.display = 'none';
                    this.dom.patternSetup.style.display = 'none';
                    this.dom.passwordSetup.style.display = 'none';
                    
                    // Show selected form and clear inputs for setup
                    if (type === 'pin') {
                        this.dom.pinSetup.style.display = 'block';
                        this.dom.pinInputs.forEach(input => input.value = '');
                        this.dom.pinInputs[0].focus();
                    } else if (type === 'pattern') {
                        this.dom.patternSetup.style.display = 'block';
                        this.selectedPattern = []; // Reset for new pattern setting
                        this.dom.patternDots.forEach(d => d.classList.remove('selected'));
                        this.dom.patternInstructions.textContent = 'Draw your pattern by connecting at least 4 dots';
                    } else if (type === 'password') {
                        this.dom.passwordSetup.style.display = 'block';
                        this.dom.passwordInput.value = '';
                        this.dom.confirmPasswordInput.value = '';
                        this.dom.passwordInput.focus();
                    }
                    
                    // Update active state
                    this.dom.passwordOptions.forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                });
            });
            
            // PIN input handling (in settings modal)
            this.dom.pinInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value && index < this.dom.pinInputs.length - 1) {
                        this.dom.pinInputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        this.dom.pinInputs[index - 1].focus();
                    }
                });
            });
            
            // Save PIN (in settings modal)
            this.dom.savePinBtn.addEventListener('click', () => {
                let pin = '';
                this.dom.pinInputs.forEach(input => {
                    pin += input.value;
                });
                
                if (pin.length === 4) {
                    this.securityType = 'pin';
                    this.securityValue = pin;
                    this.saveSettings();
                    this.showToast('PIN set successfully', 'success');
                    this.dom.pinSetup.style.display = 'none';
                    this.dom.passwordOptions.forEach(o => o.classList.remove('active')); // Deselect option
                } else {
                    this.showToast('Please enter a 4-digit PIN', 'error');
                }
            });
            
            this.dom.cancelPinBtn.addEventListener('click', () => {
                this.dom.pinSetup.style.display = 'none';
                this.dom.passwordOptions.forEach(o => o.classList.remove('active'));
                this.dom.pinInputs.forEach(input => input.value = ''); // Clear inputs
            });
            
            // Pattern handling (in settings modal)
            this.dom.patternDots.forEach(dot => {
                dot.addEventListener('click', () => {
                    const dotId = dot.dataset.dot;
                    
                    if (!this.selectedPattern.includes(dotId)) {
                        this.selectedPattern.push(dotId);
                        dot.classList.add('selected');
                        
                        if (this.selectedPattern.length >= 4) {
                            this.dom.patternInstructions.textContent = 'Pattern saved. Click save to confirm.';
                        }
                    } else {
                        // Allow deselection for setup, or clear all if trying to draw again
                        this.showToast('To redraw, cancel and reopen pattern setup.', 'info');
                    }
                });
            });
            
            // Save pattern (in settings modal)
            this.dom.savePatternBtn.addEventListener('click', () => {
                if (this.selectedPattern.length >= 4) {
                    this.securityType = 'pattern';
                    this.securityValue = this.selectedPattern.join(''); // Store as string
                    this.saveSettings();
                    this.showToast('Pattern set successfully', 'success');
                    this.dom.patternSetup.style.display = 'none';
                    this.dom.passwordOptions.forEach(o => o.classList.remove('active')); // Deselect option

                    // Reset pattern dots for next time settings modal is opened
                    this.selectedPattern = [];
                    this.dom.patternDots.forEach(d => d.classList.remove('selected'));
                } else {
                    this.showToast('Pattern must have at least 4 dots', 'error');
                }
            });
            
            this.dom.cancelPatternBtn.addEventListener('click', () => {
                this.dom.patternSetup.style.display = 'none';
                this.dom.passwordOptions.forEach(o => o.classList.remove('active'));
                this.selectedPattern = []; // Clear pattern
                this.dom.patternDots.forEach(d => d.classList.remove('selected')); // Clear visual
                this.dom.patternInstructions.textContent = 'Draw your pattern by connecting at least 4 dots'; // Reset instructions
            });
            
            // Password handling (in settings modal)
            this.dom.togglePasswordBtn.addEventListener('click', () => {
                const type = this.dom.passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                this.dom.passwordInput.setAttribute('type', type);
                this.dom.confirmPasswordInput.setAttribute('type', type);
                this.dom.togglePasswordBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });
            
            // Save password (in settings modal)
            this.dom.savePasswordBtn.addEventListener('click', () => {
                const password = this.dom.passwordInput.value;
                const confirmPassword = this.dom.confirmPasswordInput.value;
                
                if (password && password === confirmPassword) {
                    this.securityType = 'password';
                    this.securityValue = password;
                    this.saveSettings();
                    this.showToast('Password set successfully', 'success');
                    this.dom.passwordSetup.style.display = 'none';
                    this.dom.passwordOptions.forEach(o => o.classList.remove('active')); // Deselect option
                    
                    // Clear inputs
                    this.dom.passwordInput.value = '';
                    this.dom.confirmPasswordInput.value = '';
                } else {
                    this.showToast('Passwords do not match or are empty', 'error');
                }
            });
            
            this.dom.cancelPasswordBtn.addEventListener('click', () => {
                this.dom.passwordSetup.style.display = 'none';
                this.dom.passwordOptions.forEach(o => o.classList.remove('active'));
                this.dom.passwordInput.value = '';
                this.dom.confirmPasswordInput.value = '';
                this.dom.passwordInput.setAttribute('type', 'password'); // Reset type
                this.dom.confirmPasswordInput.setAttribute('type', 'password');
                this.dom.togglePasswordBtn.innerHTML = '<i class="fas fa-eye"></i>'; // Reset icon
            });
            
            // Unlock button (on lock screen)
            this.dom.unlockBtn.addEventListener('click', () => {
                let isValid = false;
                
                if (this.securityType === 'pin') {
                    isValid = this.validatePin();
                } else if (this.securityType === 'pattern') {
                    isValid = this.validatePattern();
                } else if (this.securityType === 'password') {
                    isValid = this.validatePassword();
                }
                
                if (isValid) {
                    this.hideLockScreen();
                    this.showToast('Unlocked successfully', 'success');
                    // Clear all lock screen inputs regardless of type
                    this.dom.lockPinInputs.forEach(input => input.value = '');
                    this.lockScreenEnteredPattern = [];
                    this.dom.lockPatternDots.forEach(d => d.classList.remove('selected'));
                    this.dom.lockPasswordInput.value = '';
                } else {
                    this.showToast('Invalid passcode', 'error');
                    
                    // Clear inputs based on type
                    if (this.securityType === 'pin') {
                        this.dom.lockPinInputs.forEach(input => input.value = '');
                        this.dom.lockPinInputs[0].focus();
                    } else if (this.securityType === 'pattern') {
                        this.lockScreenEnteredPattern = [];
                        this.dom.lockPatternDots.forEach(d => d.classList.remove('selected'));
                        this.dom.lockPatternInstructions.textContent = 'Draw your pattern to unlock'; // Reset instructions
                    } else if (this.securityType === 'password') {
                        this.dom.lockPasswordInput.value = '';
                        this.dom.lockPasswordInput.focus();
                    }
                }
            });

            // Lock Screen PIN input handling (copy-pasted from settings for lock screen)
            this.dom.lockPinInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value && index < this.dom.lockPinInputs.length - 1) {
                        this.dom.lockPinInputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        this.dom.lockPinInputs[index - 1].focus();
                    }
                });
            });

            // Lock Screen Pattern handling
            this.dom.lockPatternDots.forEach(dot => {
                dot.addEventListener('click', () => {
                    const dotId = dot.dataset.dot;
                    if (!this.lockScreenEnteredPattern.includes(dotId)) {
                        this.lockScreenEnteredPattern.push(dotId);
                        dot.classList.add('selected'); // Visual feedback
                    }
                    // For unlock, user might click multiple times to draw. No explicit "save" here.
                    // The 'unlock-btn' will validate the current state of lockScreenEnteredPattern.
                });
            });
            
            // Lock Screen Password toggle
            this.dom.lockTogglePasswordBtn.addEventListener('click', () => {
                const type = this.dom.lockPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                this.dom.lockPasswordInput.setAttribute('type', type);
                this.dom.lockTogglePasswordBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            });
            
            // Call Controls
            this.dom.voiceCallBtn.addEventListener('click', () => this.initiateCall(false));
            this.dom.videoCallBtn.addEventListener('click', () => this.initiateCall(true));
            this.dom.hangUpBtn.addEventListener('click', () => this.endCall());
            this.dom.toggleMicBtn.addEventListener('click', () => {
                if (this.localStream) {
                    const enabled = this.localStream.getAudioTracks()[0].enabled;
                    this.localStream.getAudioTracks()[0].enabled = !enabled;
                    this.dom.toggleMicBtn.classList.toggle('off', enabled);
                }
            });
            this.dom.toggleCamBtn.addEventListener('click', () => {
                if (this.localStream) {
                    const enabled = this.localStream.getVideoTracks()[0].enabled;
                    this.localStream.getVideoTracks()[0].enabled = !enabled;
                    this.dom.toggleCamBtn.classList.toggle('off', enabled);
                }
            });
            this.dom.acceptCallBtn.addEventListener('click', () => this.answerCall());
            this.dom.declineCallBtn.addEventListener('click', () => this.declineCall());
            
            // Window resize
            window.addEventListener('resize', () => {
                 if (window.innerWidth > 768) {
                    this.dom.appContainer.classList.remove('sidebar-hidden');
                 }
            });
        },
        
        async handleTranslate(btn) {
            btn.disabled = true;
            const messageBubble = btn.closest('.message-bubble');
            const messageContent = messageBubble.querySelector('.message-content');
            const originalText = messageContent.textContent;
            const targetLang = navigator.language.split('-')[0];

            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(originalText)}&langpair=auto|${targetLang}`);
                const data = await response.json();
                if (data.responseData && data.responseStatus === 200) {
                    const translatedText = data.responseData.translatedText;
                    const translationDiv = document.createElement('div');
                    translationDiv.className = 'translation-container';
                    translationDiv.textContent = translatedText;
                    messageContent.appendChild(translationDiv);
                } else {
                    this.showToast('Translation failed.', 'error');
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Translation error:', error);
                this.showToast('Translation service unavailable.', 'error');
                btn.disabled = false;
            }
        },

        // Helper & Data Methods
        loadContacts() {
            const contacts = localStorage.getItem('aetherlink-contacts');
            this.contacts = contacts ? JSON.parse(contacts) : [];
        },
        
        saveContact() {
            const name = this.dom.contactNameInput.value.trim();
            const peerId = this.dom.contactIdInput.value.trim();
            if (name && peerId) {
                if (this.contacts.some(c => c.peerId === peerId)) {
                    this.showToast('Contact with this Peer ID already exists.', 'error');
                    return;
                }
                this.contacts.push({ name, peerId, pinned: false });
                localStorage.setItem('aetherlink-contacts', JSON.stringify(this.contacts));
                this.renderContacts();
                this.hideModal(this.dom.addContactModal);
            }
        },
        
        deleteContact(peerId) {
            this.contacts = this.contacts.filter(c => c.peerId !== peerId);
            localStorage.setItem('aetherlink-contacts', JSON.stringify(this.contacts));
            this.renderContacts();
            
            if(this.activePeerId === peerId){
                if(this.currentConnection) this.currentConnection.close();
                this.updateChatUIForNoSelection();
                this.activePeerId = null;
            }
        },
        
        togglePinContact(peerId) {
            const contact = this.contacts.find(c => c.peerId === peerId);
            if (contact) {
                contact.pinned = !contact.pinned;
                localStorage.setItem('aetherlink-contacts', JSON.stringify(this.contacts));
                this.renderContacts();
                this.showToast(`Contact ${contact.pinned ? 'pinned' : 'unpinned'}`, 'success');
            }
        },

        getContactByPeerId(peerId) {
            return this.contacts.find(c => c.peerId === peerId);
        },
        
        getContactName(peerId) {
            const contact = this.getContactByPeerId(peerId);
            return contact ? contact.name : 'Unknown Peer';
        },
        
        handleMagicLink() {
            const peerId = location.hash.substring(1);
            if (peerId && peerId !== this.myPeerId) {
                location.hash = '';
                if (this.contacts.some(c => c.peerId === peerId)) {
                    this.showToast('You already have this contact. Selecting them now.', 'info');
                    const contactEl = this.dom.contactList.querySelector(`[data-peer-id="${peerId}"]`);
                    if(contactEl) contactEl.click();
                } else {
                    this.dom.contactIdInput.value = peerId;
                    this.dom.contactNameInput.value = '';
                    this.showModal(this.dom.addContactModal);
                    this.showToast('Magic Link detected! Please name your new contact.', 'info');
                }
            }
        },
        
        async sendMessage() {
            const text = this.dom.messageInput.value.trim();
            if (text === '' || !this.currentConnection) return;
            
            try {
                const payload = { content: text, isImage: false };
                const encrypted = await this.encryptMessage(JSON.stringify(payload), this.activePeerId);
                this.currentConnection.send({ type: 'encrypted-message', payload: encrypted });
                
                this.addMessageToUI(text, 'mine');
                this.dom.messageInput.value = '';
            } catch(e) {
                console.error("Encryption/Send Error:", e);
                this.addSystemMessage("Failed to send message.");
            }
        },
        
        sendFile(file) {
            if (!this.currentConnection) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const content = event.target.result;
                const isImage = file.type.startsWith('image/');

                try {
                     const payload = { content, isImage, fileName: file.name };
                     const encrypted = await this.encryptMessage(JSON.stringify(payload), this.activePeerId);
                     this.currentConnection.send({ type: 'encrypted-message', payload: encrypted });
                     this.addMessageToUI(content, 'mine', 'You', isImage, file.name);
                } catch(e) {
                    console.error("File Encryption/Send Error:", e);
                    this.addSystemMessage("Failed to send file.");
                }
            };
            reader.readAsDataURL(file);
        },

        dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], {type: mimeString});
        }
    };

    window.onload = () => App.init();
    </script>
</body>
</html>
