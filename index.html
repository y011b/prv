<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AetherLink: Purity Edition</title>
    
    <!-- CDNs & Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 fill=%22none%22 viewBox=%220 0 24 24%22 stroke-width=%221.5%22 stroke=%22currentColor%22><path stroke-linecap=%22round%22 stroke-linejoin=%22round%22 d=%22M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.553L16.5 21.75l-.398-1.197a3.375 3.375 0 00-2.455-2.456L12.75 18l1.197-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.197a3.375 3.375 0 002.456 2.456L20.25 18l-1.197.398a3.375 3.375 0 00-2.455 2.456z%22 /></svg>">
  <style>
    /* [RE-STYLED] Part II: Visual Design & UI ("Nocturne Theme") */
    :root {
        /* Colors - Dark Mode Palette */
        --bg-primary: #111827;      /* Very Dark Blue-Gray */
        --bg-secondary: #1F2937;    /* Dark Blue-Gray */
        --bg-tertiary: #374151;     /* Medium Gray */
        --bg-input: #374151;        /* Medium Gray */
        --text-primary: #F9FAFB;    /* Near White */
        --text-secondary: #D1D5DB;  /* Light Gray */
        --text-tertiary: #9CA3AF;   /* Muted Gray */
        --accent-purple: #8B5CF6;
        --accent-purple-darker: #7C3AED;
        --border-color: #374151;
        --system-message-bg: rgba(59, 130, 246, 0.15);
        --system-message-text: #93C5FD;
        --success-green: #4ADE80;
        --error-red: #F87171;

        /* Typography & Layout */
        --font-family: 'Inter', sans-serif;
        --sidebar-width: 280px;

        /* Radii */
        --radius-lg: 16px;
        --radius-md: 12px;
        --radius-sm: 8px;

        /* Shadows */
        --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.4), 0 8px 10px -6px rgb(0 0 0 / 0.4);
    }

    /* --- Global Styles --- */
    *, *::before, *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html, body {
        height: 100%;
        overflow: hidden;
        background-color: var(--bg-primary);
        font-family: var(--font-family);
        color: var(--text-secondary);
        font-size: 16px;
    }

    /* --- Main App Layout --- */
    .app-container {
        display: flex;
        height: 100vh;
        width: 100vw;
        position: relative;
        background-color: var(--bg-secondary);
        transition: transform 0.3s ease-in-out;
    }

    /* --- Sidebar --- */
    .sidebar {
        width: var(--sidebar-width);
        height: 100%;
        background-color: var(--bg-primary);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        transition: transform 0.3s ease-in-out;
    }

    .sidebar-header, .sidebar-footer {
        padding: 20px;
        flex-shrink: 0;
    }

    .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-color);
    }
    /* New: Container for sidebar header actions */
    .sidebar-header-actions {
        display: flex;
        gap: 8px; /* Space between buttons */
    }

    .logo { display: flex; align-items: center; gap: 10px; }
    .logo svg { width: 28px; height: 28px; color: var(--accent-purple); }
    .logo-text { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }

    .add-contact-btn { background: none; border: none; cursor: pointer; padding: 4px; border-radius: var(--radius-sm); transition: background-color 0.2s ease; }
    .add-contact-btn:hover { background-color: var(--bg-tertiary); }
    .add-contact-btn svg { width: 24px; height: 24px; color: var(--text-secondary); }

    /* New: Style for the sidebar close button (initially hidden on desktop) */
    .sidebar-close-btn {
        display: none; /* Hidden by default on large screens */
    }

    .contact-list { list-style: none; flex-grow: 1; overflow-y: auto; padding: 8px; }

    .contact-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        margin-bottom: 4px;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0;
        transform: translateY(10px);
        animation: fadeInSlideUp 0.5s ease forwards;
    }

    .contact-item:hover { background-color: var(--bg-tertiary); }
    .contact-item.active {
        background: var(--accent-purple);
        color: white;
        box-shadow: var(--shadow-medium);
    }
    .contact-item.active .contact-name { color: white; }
    .contact-item.active .delete-contact-btn svg { color: white; }
    
    .contact-name { font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .delete-contact-btn { background: none; border: none; cursor: pointer; opacity: 0; transition: opacity 0.2s; padding: 4px; border-radius: 50%; }
    .contact-item:hover .delete-contact-btn { opacity: 1; }
    .delete-contact-btn:hover { background-color: rgba(255,255,255,0.1); }
    .delete-contact-btn svg { width: 18px; height: 18px; color: var(--text-secondary); }

    .sidebar-footer { border-top: 1px solid var(--border-color); }
    .your-id-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .your-id-title { font-size: 0.875rem; font-weight: 600; color: var(--text-primary); }
    .your-id-actions { display: flex; gap: 8px; }
    .id-action-btn { background: none; border: none; cursor: pointer; padding: 4px; border-radius: var(--radius-sm); transition: background-color 0.2s ease; }
    .id-action-btn:hover { background-color: var(--bg-tertiary); }
    .id-action-btn svg { width: 20px; height: 20px; color: var(--text-secondary); }
    .your-id-display { background-color: var(--bg-input); padding: 8px 12px; border-radius: var(--radius-md); font-family: monospace; font-size: 0.8rem; color: var(--text-tertiary); word-break: break-all; text-align: center; }

    /* --- Chat Area --- */
    .chat-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--bg-secondary); height: 100vh; }
    .chat-header { display: flex; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; gap: 12px; }
    .hamburger-menu { display: none; background: none; border: none; cursor: pointer; padding: 4px; }
    .hamburger-menu svg { width: 28px; height: 28px; color: var(--text-secondary); }
    .chat-contact-info { flex-grow: 1; }
    .chat-contact-name { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); }
    .chat-contact-status { font-size: 0.875rem; color: var(--text-tertiary); }
    .chat-contact-status.connected { color: var(--success-green); }
    .chat-contact-status.disconnected { color: var(--error-red); }
    .chat-actions { display: flex; align-items: center; gap: 12px; }
    .chat-action-btn { background: none; border: none; cursor: pointer; padding: 6px; border-radius: var(--radius-sm); transition: all 0.2s ease; }
    .chat-action-btn svg { width: 24px; height: 24px; color: var(--text-secondary); }
    .chat-action-btn:hover:not(:disabled) { background-color: var(--bg-tertiary); }
    .chat-action-btn:disabled { cursor: not-allowed; opacity: 0.4; }

    .ghost-mode-toggle { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; padding: 6px 10px; border-radius: var(--radius-md); }
    .ghost-mode-toggle.active { background-color: var(--accent-purple); color: white; }
    .ghost-mode-toggle.active svg { color: white; }

    .message-list { flex-grow: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; }
    .empty-chat { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: var(--text-tertiary); }
    .empty-chat-logo { margin-bottom: 16px; }
    .empty-chat-logo svg { width: 64px; height: 64px; color: var(--bg-primary); }
    .empty-chat h2 { font-size: 1.5rem; color: var(--text-primary); margin-bottom: 8px; }

    .message-item { display: flex; max-width: 75%; opacity: 0; transform: translateY(10px); animation: fadeInSlideUp 0.5s ease forwards; transition: opacity 0.5s ease, transform 0.5s ease; }
    .message-item.disappearing { opacity: 0; transform: scale(0.8); }
    .message-item.mine { align-self: flex-end; }
    .message-item.theirs { align-self: flex-start; }
    .message-item.system { align-self: center; max-width: 100%; }

    .message-bubble { padding: 12px 16px; border-radius: var(--radius-lg); position: relative; box-shadow: var(--shadow-soft); }
    .message-bubble.mine { background-image: linear-gradient(to right, var(--accent-purple), var(--accent-purple-darker)); color: white; border-bottom-right-radius: var(--radius-sm); }
    .message-bubble.theirs { background-color: var(--bg-tertiary); color: var(--text-primary); border-bottom-left-radius: var(--radius-sm); }
    .message-bubble.system { background-color: var(--system-message-bg); color: var(--system-message-text); font-size: 0.875rem; text-align: center; }
    .message-content img { max-width: 100%; border-radius: var(--radius-md); margin-top: 8px; cursor: pointer; }
    .message-content a { display: block; margin-top: 8px; padding: 8px; background-color: rgba(255,255,255,0.05); border-radius: var(--radius-sm); color: inherit; text-decoration: none; font-weight: 500; }
    
    .translation-container { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); font-style: italic; opacity: 0.8; }
    .message-bubble.theirs .translation-container { border-top-color: rgba(255,255,255,0.1); }
    
    .message-meta { display: flex; align-items: center; justify-content: flex-end; margin-top: 8px; gap: 8px; }
    .translate-btn { background: none; border: none; cursor: pointer; padding: 2px; }
    .translate-btn svg { width: 16px; height: 16px; color: var(--text-tertiary); }
    .translate-btn:disabled svg { opacity: 0.3; cursor: not-allowed; }
    .message-bubble.mine .translate-btn svg { color: rgba(255,255,255,0.7); }

    .message-form { display: flex; padding: 16px 24px; border-top: 1px solid var(--border-color); gap: 12px; align-items: center; }
    .file-input-label { cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s ease; }
    .file-input-label:hover { background-color: var(--bg-tertiary); }
    .file-input-label svg { width: 24px; height: 24px; color: var(--text-secondary); }
    #file-input { display: none; }

    .message-input { flex-grow: 1; border: none; background-color: var(--bg-input); border-radius: var(--radius-md); padding: 12px 16px; font-size: 1rem; color: var(--text-primary); }
    .message-input::placeholder { color: var(--text-tertiary); }
    .message-input:focus { outline: 2px solid var(--accent-purple); }
    .send-btn { background-color: var(--accent-purple); border: none; border-radius: var(--radius-md); padding: 12px; cursor: pointer; transition: background-color 0.2s ease; }
    .send-btn:hover:not(:disabled) { background-color: var(--accent-purple-darker); }
    .send-btn svg { color: white; width: 24px; height: 24px; display: block; }
    .message-form :disabled { cursor: not-allowed; opacity: 0.5; }

    /* --- Modals & Overlays --- */
    .modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(17, 24, 39, 0.6);
        backdrop-filter: blur(8px);
        display: flex; align-items: center; justify-content: center; z-index: 1000;
        opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-backdrop.visible { opacity: 1; visibility: visible; }
    .modal {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        width: 90%; max-width: 400px;
        transform: scale(0.95); transition: transform 0.3s ease; overflow: hidden;
    }
    .modal-backdrop.visible .modal { transform: scale(1); }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
    .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }
    .modal-body { padding: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-primary); }
    .form-group input { width: 100%; border: 1px solid var(--border-color); background-color: var(--bg-input); border-radius: var(--radius-md); padding: 12px 16px; font-size: 1rem; color: var(--text-primary); }
    .form-group input:focus { outline: 2px solid var(--accent-purple); border-color: transparent; }
    .modal-footer { display: flex; justify-content: flex-end; padding: 16px 24px; background-color: var(--bg-primary); }
    .modal-btn { padding: 10px 20px; border-radius: var(--radius-md); border: none; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease; background-color: var(--bg-tertiary); color: var(--text-primary); }
    .modal-btn:hover { background-color: #4B5563; }
    .primary-btn { background-color: var(--accent-purple); color: white; }
    .primary-btn:hover { background-color: var(--accent-purple-darker); }

    #qr-code-container { display: flex; justify-content: center; margin-bottom: 20px; padding: 16px; background: white; border-radius: var(--radius-md); }
    /* Added style for the canvas itself */
    #qr-code-canvas { display: block; max-width: 100%; height: auto; }


    /* --- Toast Notifications --- */
    .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .toast { background-color: var(--bg-tertiary); color: var(--text-primary); padding: 12px 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow-medium); opacity: 0; transform: translateY(20px); animation: toast-in 0.3s ease forwards; }
    @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
    @keyframes toast-out { to { opacity: 0; transform: translateY(20px); } }

    /* --- Call UI --- */
    .call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); z-index: 1500; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
    .call-overlay.visible { opacity: 1; visibility: visible; }
    #remote-video { width: 100%; height: 100%; object-fit: contain; }
    #local-video { position: absolute; bottom: 100px; right: 20px; width: 200px; height: 150px; border-radius: var(--radius-md); border: 2px solid rgba(255,255,255,0.5); box-shadow: var(--shadow-lg); object-fit: cover; }
    .call-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 16px; background-color: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 12px 24px; border-radius: 50px; }
    .call-control-btn { background-color: rgba(255,255,255,0.1); border: none; width: 56px; height: 56px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; }
    .call-control-btn svg { width: 28px; height: 28px; color: white; }
    .call-control-btn:hover { background-color: rgba(255,255,255,0.2); }
    .call-control-btn.hang-up { background-color: #EF4444; }
    .call-control-btn.hang-up:hover { background-color: #DC2626; }
    .call-control-btn.off { background-color: #4B5563; }

    /* Incoming Call Notification */
    .incoming-call-notification {
        position: fixed; top: 20px; right: 20px;
        background-color: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 20px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
        z-index: 1600; display: flex; flex-direction: column; gap: 12px; align-items: center;
        transform: translateX(120%); transition: transform 0.4s ease-in-out;
    }
    .incoming-call-notification.visible { transform: translateX(0); }
    .incoming-call-actions { display: flex; gap: 12px; }
    .incoming-call-btn { padding: 10px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .incoming-call-btn svg { width: 24px; height: 24px; color: white; }
    #accept-call-btn { background-color: var(--success-green); }
    #decline-call-btn { background-color: var(--error-red); }

    /* Animations */
    @keyframes fadeInSlideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Responsiveness */
    @media (max-width: 768px) {
        /* Sidebar is hidden by default on mobile */
        .app-container.sidebar-hidden .sidebar { 
            transform: translateX(-100%); 
        }
        /* When sidebar is not hidden, make it an overlay */
        .sidebar { 
            position: fixed; /* Changed to fixed for overlay behavior */
            top: 0;
            left: 0;
            width: 100%; /* Make sidebar full width on mobile for better overlay */
            height: 100%;
            z-index: 500; /* Ensure it overlays chat area */
            box-shadow: var(--shadow-lg);
            /* Already has transition: transform 0.3s ease-in-out; */
        }
        /* Show the close button when sidebar is active/open on mobile */
        .app-container:not(.sidebar-hidden) .sidebar-close-btn {
            display: block;
        }
        /* The main chat hamburger menu should still be block */
        .hamburger-menu { display: block; }
    }
</style>
</head>
<body oncontextmenu="return false;">

    <!-- Part III: Application HTML Structure -->
    <div id="app-container" class="app-container sidebar-hidden">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.553L16.5 21.75l-.398-1.197a3.375 3.375 0 00-2.455-2.456L12.75 18l1.197-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.197a3.375 3.375 0 002.456 2.456L20.25 18l-1.197.398a3.375 3.375 0 00-2.455 2.456z" /></svg>
                    <span class="logo-text">AetherLink</span>
                </div>
                <!-- New actions container for close button and add contact button -->
                <div class="sidebar-header-actions">
                    <button class="add-contact-btn sidebar-close-btn" id="sidebar-close-btn" title="Close Sidebar">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    <button class="add-contact-btn" id="add-contact-btn-main">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </button>
                </div>
            </div>
            <ul class="contact-list" id="contact-list"></ul>
            <div class="sidebar-footer">
                <div class="your-id-header">
                    <span class="your-id-title">Your ID</span>
                    <div class="your-id-actions">
                        <button class="id-action-btn" id="copy-id-btn" title="Copy ID">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" /></svg>
                        </button>
                        <button class="id-action-btn" id="share-id-btn" title="Share ID">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 100-2.186m0 2.186c-.18.324-.283.696-.283 1.093s.103.77.283 1.093m-7.5-12.28a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093" /></svg>
                        </button>
                    </div>
                </div>
                <div class="your-id-display" id="your-id-display">Initializing...</div>
            </div>
        </aside>

        <!-- Chat Area -->
        <main class="chat-area">
            <div class="chat-header">
                 <!-- Hamburger menu with YouTube style -->
                 <button class="hamburger-menu" id="hamburger-menu" aria-label="Guide" aria-pressed="false">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" focusable="false" fill="currentColor">
                        <path d="M21 6H3V5h18v1zm0 5H3v1h18v-1zm0 6H3v1h18v-1z"></path>
                    </svg>
                </button>
                <div class="chat-contact-info">
                    <div class="chat-contact-name" id="chat-contact-name">Select a contact</div>
                    <div class="chat-contact-status" id="chat-contact-status"></div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn ghost-mode-toggle" id="ghost-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                        Ghost
                    </button>
                    <button class="chat-action-btn" id="voice-call-btn" title="Voice Call" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 6.75z" /></svg>
                    </button>
                    <button class="chat-action-btn" id="video-call-btn" title="Video Call" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9A2.25 2.25 0 004.5 18.75z" /></svg>
                    </button>
                </div>
            </div>
            <div class="message-list" id="message-list">
                <div class="empty-chat" id="empty-chat-screen">
                    <div class="empty-chat-logo">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.553L16.5 21.75l-.398-1.197a3.375 3.375 0 00-2.455-2.456L12.75 18l1.197-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.197a3.375 3.375 0 002.456 2.456L20.25 18l-1.197.398a3.375 3.375 0 00-2.455 2.456z" /></svg>
                    </div>
                    <h2>Welcome to AetherLink</h2>
                    <p>Select a contact to start a secure, end-to-end encrypted conversation.</p>
                </div>
            </div>
            <form class="message-form" id="message-form">
                <label for="file-input" class="file-input-label">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" /></svg>
                </label>
                <input type="file" id="file-input" disabled>
                <input type="text" class="message-input" id="message-input" placeholder="Type a message..." autocomplete="off" disabled>
                <button type="submit" class="send-btn" id="send-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>
                </button>
            </form>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-backdrop" id="add-contact-modal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Add New Contact</h3></div>
            <div class="modal-body">
                <form id="add-contact-form">
                    <div class="form-group">
                        <label for="contact-name-input">Contact Name</label>
                        <input type="text" id="contact-name-input" required>
                    </div>
                    <div class="form-group">
                        <label for="contact-id-input">Peer ID</label>
                        <input type="text" id="contact-id-input" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="cancel-add-contact-btn">Cancel</button>
                <button class="modal-btn primary-btn" id="save-contact-btn">Save</button>
            </div>
        </div>
    </div>
    
    <div class="modal-backdrop" id="share-id-modal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Share Your ID</h3></div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-secondary); text-align: center;">Share this magic link or QR code to connect.</p>
                <!-- [MODIFIED HTML] - Added canvas element for QR code -->
                <div id="qr-code-container">
                    <canvas id="qr-code-canvas"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                 <button class="modal-btn" id="cancel-share-btn">Close</button>
                <button class="modal-btn primary-btn" id="share-link-btn">Share Link</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Call UI -->
    <div class="call-overlay" id="call-overlay">
        <video id="remote-video" autoplay></video>
        <video id="local-video" autoplay muted></video>
        <div class="call-controls">
            <button class="call-control-btn" id="toggle-mic-btn" title="Mute/Unmute Mic">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m12 0v-1.5a6 6 0 00-6-6v0a6 6 0 00-6 6v1.5m12 0v-1.5a6 6 0 00-6-6v0a6 6 0 00-6 6v1.5" /></svg>
            </button>
            <button class="call-control-btn" id="toggle-cam-btn" title="Turn Camera On/Off">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9A2.25 2.25 0 004.5 18.75z" /></svg>
            </button>
            <button class="call-control-btn hang-up" id="hang-up-btn" title="Hang Up">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6.75l-9 9M6.75 6.75l9 9" /></svg>
            </button>
        </div>
    </div>
    
    <div class="incoming-call-notification" id="incoming-call-notification">
        <p id="incoming-call-text">Incoming call...</p>
        <div class="incoming-call-actions">
            <button class="incoming-call-btn" id="decline-call-btn" title="Decline">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6.75l-9 9M6.75 6.75l9 9" /></svg>
            </button>
            <button class="incoming-call-btn" id="accept-call-btn" title="Accept">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 6.75z" /></svg>
            </button>
        </div>
    </div>


    <script>
    // Part I & III: Core Architecture, Features & Logic
    const App = {
        // --- State ---
        peer: null,
        myPeerId: null,
        currentConnection: null,
        activePeerId: null,
        sharedSecrets: new Map(),
        keyPair: null,
        contacts: [],
        ghostMode: false,
        currentCall: null,
        localStream: null,
        incomingCall: null,

        // --- DOM Elements ---
        dom: {},

        // --- Main Initialization ---
        init() {
            this.cacheDom();
            this.bindEventListeners();
            this.hardenApplication();
            this.loadContacts();
            this.renderContacts();
            this.updateChatUIForNoSelection();
            this.generateKeys().then(() => {
                this.initializePeer();
            });
            
            // Check for mobile and hide sidebar initially
            if (window.innerWidth <= 768) {
                this.dom.appContainer.classList.add('sidebar-hidden');
            } else {
                 this.dom.appContainer.classList.remove('sidebar-hidden');
            }
            
            // Set initial ARIA state for the new hamburger button
            const isInitiallyHidden = this.dom.appContainer.classList.contains('sidebar-hidden');
            this.dom.hamburgerMenu.setAttribute('aria-pressed', !isInitiallyHidden);
        },

        cacheDom() {
            this.dom = {
                appContainer: document.getElementById('app-container'),
                sidebar: document.querySelector('.sidebar'),
                // [MODIFIED JAVASCRIPT] - Added sidebarCloseBtn to DOM cache
                sidebarCloseBtn: document.getElementById('sidebar-close-btn'), 
                hamburgerMenu: document.getElementById('hamburger-menu'),
                // Sidebar
                addContactBtn: document.getElementById('add-contact-btn-main'),
                contactList: document.getElementById('contact-list'),
                yourIdDisplay: document.getElementById('your-id-display'),
                copyIdBtn: document.getElementById('copy-id-btn'),
                shareIdBtn: document.getElementById('share-id-btn'),
                // Chat Area
                chatContactName: document.getElementById('chat-contact-name'),
                chatContactStatus: document.getElementById('chat-contact-status'),
                messageList: document.getElementById('message-list'),
                emptyChatScreen: document.getElementById('empty-chat-screen'),
                messageForm: document.getElementById('message-form'),
                messageInput: document.getElementById('message-input'),
                sendBtn: document.getElementById('send-btn'),
                fileInput: document.getElementById('file-input'),
                ghostModeToggle: document.getElementById('ghost-mode-toggle'),
                voiceCallBtn: document.getElementById('voice-call-btn'),
                videoCallBtn: document.getElementById('video-call-btn'),
                // Modals
                addContactModal: document.getElementById('add-contact-modal'),
                contactNameInput: document.getElementById('contact-name-input'),
                contactIdInput: document.getElementById('contact-id-input'),
                saveContactBtn: document.getElementById('save-contact-btn'),
                cancelAddContactBtn: document.getElementById('cancel-add-contact-btn'),
                shareIdModal: document.getElementById('share-id-modal'),
                qrCodeContainer: document.getElementById('qr-code-container'),
                // [MODIFIED JAVASCRIPT] - Added new DOM element for the canvas
                qrCodeCanvas: document.getElementById('qr-code-canvas'), 
                shareLinkBtn: document.getElementById('share-link-btn'),
                cancelShareBtn: document.getElementById('cancel-share-btn'),
                // Toasts
                toastContainer: document.getElementById('toast-container'),
                // Call UI
                callOverlay: document.getElementById('call-overlay'),
                remoteVideo: document.getElementById('remote-video'),
                localVideo: document.getElementById('local-video'),
                toggleMicBtn: document.getElementById('toggle-mic-btn'),
                toggleCamBtn: document.getElementById('toggle-cam-btn'),
                hangUpBtn: document.getElementById('hang-up-btn'),
                incomingCallNotification: document.getElementById('incoming-call-notification'),
                incomingCallText: document.getElementById('incoming-call-text'),
                acceptCallBtn: document.getElementById('accept-call-btn'),
                declineCallBtn: document.getElementById('decline-call-btn'),
            };
        },

        // --- Security & Hardening ---
        hardenApplication() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F12' ||
                    (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) ||
                    (e.metaKey && e.altKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) ||
                    (e.ctrlKey && e.key.toUpperCase() === 'U') ||
                    (e.ctrlKey && e.key.toUpperCase() === 'S')) {
                    e.preventDefault();
                }
            });
        },
        
        // --- E2EE Cryptography ---
        async generateKeys() {
            this.keyPair = await window.crypto.subtle.generateKey(
                { name: 'ECDH', namedCurve: 'P-384' },
                true,
                ['deriveKey']
            );
        },

        async deriveSharedSecret(peerPublicKeyJwk) {
            const peerPublicKey = await window.crypto.subtle.importKey(
                'jwk',
                peerPublicKeyJwk,
                { name: 'ECDH', namedCurve: 'P-384' },
                true,
                []
            );
            return await window.crypto.subtle.deriveKey(
                { name: 'ECDH', public: peerPublicKey },
                this.keyPair.privateKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        },

        async encryptMessage(text, peerId) {
            const sharedSecret = this.sharedSecrets.get(peerId);
            if (!sharedSecret) throw new Error('No shared secret for this peer.');
            
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encodedText = new TextEncoder().encode(text);
            
            const encryptedData = await window.crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                sharedSecret,
                encodedText
            );
            
            // Using array for smaller payload vs base64 strings
            return {
                iv: Array.from(iv),
                data: Array.from(new Uint8Array(encryptedData))
            };
        },

        async decryptMessage(encryptedPayload, peerId) {
            const sharedSecret = this.sharedSecrets.get(peerId);
            if (!sharedSecret) throw new Error('No shared secret for this peer.');

            const iv = new Uint8Array(encryptedPayload.iv);
            const data = new Uint8Array(encryptedPayload.data);

            const decryptedData = await window.crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                sharedSecret,
                data
            );
            
            return new TextDecoder().decode(decryptedData);
        },

        // --- PeerJS & Connection Management ---
        initializePeer() {
            this.peer = new Peer({
                // For local testing, you might need to specify host/port
                // For production, PeerServer cloud is used by default
            });

            this.peer.on('open', (id) => {
                this.myPeerId = id;
                this.dom.yourIdDisplay.textContent = id;
                this.handleMagicLink();
            });

            this.peer.on('connection', (conn) => {
                this.handleNewConnection(conn);
            });
            
            this.peer.on('call', (call) => {
                this.handleIncomingCall(call);
            });
            
            this.peer.on('error', (err) => {
                console.error('PeerJS Error:', err);
                this.showToast(`Error: ${err.type}`, 'error');
                if (err.type === 'peer-unavailable' && this.activePeerId) {
                    this.updateConnectionStatusUI('Disconnected');
                    this.addSystemMessage(`${this.getContactName(this.activePeerId)} is unavailable.`);
                    this.setChatInputEnabled(false);
                }
            });
        },

        connectToPeer(peerId) {
            if (this.currentConnection) {
                this.currentConnection.close();
            }
            this.updateConnectionStatusUI('Connecting...');
            
            const conn = this.peer.connect(peerId, { reliable: true });
            this.handleNewConnection(conn);
        },

        async handleNewConnection(conn) {
            conn.on('open', async () => {
                this.currentConnection = conn;
                this.activePeerId = conn.peer;

                // Start Handshake
                const publicKeyJwk = await window.crypto.subtle.exportKey('jwk', this.keyPair.publicKey);
                conn.send({ type: 'handshake', publicKey: publicKeyJwk });
                
                this.updateChatUIForActiveConnection(conn.peer);
            });

            conn.on('data', (data) => this.handleData(conn, data));

            conn.on('close', () => {
                if (this.currentConnection && this.currentConnection.peer === conn.peer) {
                    this.addSystemMessage(`Connection to ${this.getContactName(conn.peer)} closed.`);
                    this.updateConnectionStatusUI('Disconnected');
                    this.setChatInputEnabled(false);
                    this.currentConnection = null;
                    this.activePeerId = null;
                }
            });
        },

        async handleData(conn, data) {
            try {
                switch(data.type) {
                    case 'handshake': {
                        const sharedSecret = await this.deriveSharedSecret(data.publicKey);
                        this.sharedSecrets.set(conn.peer, sharedSecret);
                        
                        const myPublicKeyJwk = await window.crypto.subtle.exportKey('jwk', this.keyPair.publicKey);
                        conn.send({ type: 'handshake-ack', publicKey: myPublicKeyJwk });
                        
                        // Receiver considers connection secure now
                        this.updateConnectionStatusUI('Connected');
                        this.setChatInputEnabled(true);
                        this.addSystemMessage(`Connection with ${this.getContactName(conn.peer)} is now secure.`);
                        break;
                    }
                    case 'handshake-ack': {
                        const sharedSecret = await this.deriveSharedSecret(data.publicKey);
                        this.sharedSecrets.set(conn.peer, sharedSecret);

                        // Initiator considers connection secure now
                        this.updateConnectionStatusUI('Connected');
                        this.setChatInputEnabled(true);
                        this.addSystemMessage(`Connection with ${this.getContactName(conn.peer)} is now secure.`);
                        break;
                    }
                    case 'encrypted-message': {
                        const decrypted = await this.decryptMessage(data.payload, conn.peer);
                        const messageData = JSON.parse(decrypted);
                        this.addMessageToUI(messageData.content, 'theirs', this.getContactName(conn.peer), messageData.isImage, messageData.fileName);
                        break;
                    }
                }
            } catch (error) {
                console.error("Data handling error:", error);
                this.addSystemMessage("An error occurred while processing a message.");
            }
        },

        // --- UI & UX Methods ---
        showModal(modal) {
            modal.classList.add('visible');
        },
        
        hideModal(modal) {
            modal.classList.remove('visible');
        },
        
        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            
            if (type === 'success') toast.style.backgroundColor = 'var(--success-green)';
            if (type === 'error') toast.style.backgroundColor = 'var(--error-red)';

            this.dom.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toast-out 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        },

        renderContacts() {
            this.dom.contactList.innerHTML = '';
            this.contacts.forEach((contact, index) => {
                const li = document.createElement('li');
                li.className = 'contact-item';
                li.dataset.peerId = contact.peerId;
                if(contact.peerId === this.activePeerId) {
                    li.classList.add('active');
                }
                li.style.animationDelay = `${index * 50}ms`;
                li.innerHTML = `
                    <span class="contact-name">${contact.name}</span>
                    <button class="delete-contact-btn" data-peer-id="${contact.peerId}" title="Delete Contact">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                `;
                this.dom.contactList.appendChild(li);
            });
        },

        addMessageToUI(content, type, senderName, isImage = false, fileName = '') {
            this.dom.emptyChatScreen.style.display = 'none';
            const item = document.createElement('div');
            item.className = `message-item ${type}`;
            
            let messageContentHTML;
            if (isImage) {
                messageContentHTML = `<img src="${content}" alt="Image from ${senderName}">`;
            } else if (fileName) {
                 const blob = this.dataURItoBlob(content);
                 const url = URL.createObjectURL(blob);
                 messageContentHTML = `<a href="${url}" download="${fileName}">Download: ${fileName}</a>`;
            } else {
                messageContentHTML = content.replace(/\n/g, '<br>');
            }

            const metaHTML = type === 'theirs'
                ? `<div class="message-meta">
                       <button class="translate-btn" title="Translate">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C13.18 7.061 14.122 7.5 15 7.5h6M9 15V6.75A2.25 2.25 0 0111.25 4.5h3.75a2.25 2.25 0 012.25 2.25v4.133m-12.867 5.197L3 21m0 0l2.133-2.133" /></svg>
                       </button>
                   </div>`
                : '';
                
            item.innerHTML = `
                <div class="message-bubble ${type}">
                    <div class="message-content">${messageContentHTML}</div>
                    ${metaHTML}
                </div>
            `;
            this.dom.messageList.appendChild(item);

            // Ephemeral Messages
            const timeoutDuration = this.ghostMode ? 30 * 1000 : 2 * 60 * 1000;
            setTimeout(() => {
                item.classList.add('disappearing');
                setTimeout(() => item.remove(), 500);
            }, timeoutDuration);

            this.dom.messageList.scrollTop = this.dom.messageList.scrollHeight;
        },

        addSystemMessage(text) {
            this.addMessageToUI(text, 'system');
        },

        updateChatUIForNoSelection() {
            this.dom.chatContactName.textContent = 'Select a contact';
            this.dom.chatContactStatus.textContent = '';
            this.dom.chatContactStatus.className = 'chat-contact-status';
            this.dom.messageList.innerHTML = '';
            this.dom.emptyChatScreen.style.display = 'flex';
            this.setChatInputEnabled(false);
        },

        updateChatUIForActiveConnection(peerId) {
            const contact = this.getContactByPeerId(peerId);
            this.dom.chatContactName.textContent = contact ? contact.name : peerId;
            this.dom.messageList.innerHTML = '';
            this.dom.emptyChatScreen.style.display = 'none';
        },
        
        updateConnectionStatusUI(status) {
            this.dom.chatContactStatus.textContent = status;
            this.dom.chatContactStatus.className = 'chat-contact-status';
            if (status === 'Connected') this.dom.chatContactStatus.classList.add('connected');
            if (status === 'Disconnected') this.dom.chatContactStatus.classList.add('disconnected');
        },
        
        setChatInputEnabled(enabled) {
            this.dom.messageInput.disabled = !enabled;
            this.dom.sendBtn.disabled = !enabled;
            this.dom.fileInput.disabled = !enabled;
            this.dom.voiceCallBtn.disabled = !enabled;
            this.dom.videoCallBtn.disabled = !enabled;
        },
        
        // --- Call Logic ---
        async initiateCall(video = false) {
            try {
                this.localStream = await navigator.mediaDevices.getUserMedia({ video, audio: true });
                this.dom.localVideo.srcObject = this.localStream;
                this.currentCall = this.peer.call(this.activePeerId, this.localStream);
                this.showCallUI();
                this.setupCallListeners(this.currentCall);
            } catch (err) {
                console.error('Failed to get local stream', err);
                this.showToast('Could not access camera/mic.', 'error');
            }
        },

        handleIncomingCall(call) {
            this.incomingCall = call;
            const contactName = this.getContactName(call.peer);
            this.dom.incomingCallText.textContent = `Incoming call from ${contactName}`;
            this.dom.incomingCallNotification.classList.add('visible');
        },

        async answerCall() {
            try {
                this.dom.incomingCallNotification.classList.remove('visible');
                const video = this.incomingCall.metadata && this.incomingCall.metadata.video;
                this.localStream = await navigator.mediaDevices.getUserMedia({ video, audio: true });
                this.dom.localVideo.srcObject = this.localStream;
                this.incomingCall.answer(this.localStream);
                this.currentCall = this.incomingCall;
                this.showCallUI();
                this.setupCallListeners(this.currentCall);
                this.incomingCall = null;
            } catch (err) {
                console.error('Failed to get local stream for answer', err);
                this.showToast('Could not access camera/mic.', 'error');
            }
        },
        
        declineCall() {
            if (this.incomingCall) {
                this.incomingCall.close();
                this.incomingCall = null;
            }
            this.dom.incomingCallNotification.classList.remove('visible');
        },

        setupCallListeners(call) {
            call.on('stream', (remoteStream) => {
                this.dom.remoteVideo.srcObject = remoteStream;
            });
            call.on('close', () => {
                this.endCall();
            });
            call.on('error', (err) => {
                console.error("Call error:", err);
                this.endCall();
                this.showToast("Call error occurred.", 'error');
            });
        },
        
        showCallUI() {
            this.dom.callOverlay.classList.add('visible');
            this.resetCallButtons();
        },
        
        endCall() {
            if (this.currentCall) {
                this.currentCall.close();
            }
            if (this.localStream) {
                this.localStream.getTracks().forEach(track => track.stop());
                this.localStream = null;
            }
            this.dom.callOverlay.classList.remove('visible');
            this.dom.remoteVideo.srcObject = null;
            this.dom.localVideo.srcObject = null;
            this.currentCall = null;
        },
        
        resetCallButtons() {
            this.dom.toggleMicBtn.classList.remove('off');
            this.dom.toggleCamBtn.classList.remove('off');
        },

        // --- Event Handlers & Binding ---
        bindEventListeners() {
            // Sidebar
            this.dom.addContactBtn.addEventListener('click', () => {
                this.dom.contactNameInput.value = '';
                this.dom.contactIdInput.value = '';
                this.showModal(this.dom.addContactModal);
            });
            // [MODIFIED JAVASCRIPT] - Added listener for sidebar close button
            this.dom.sidebarCloseBtn.addEventListener('click', () => {
                this.dom.appContainer.classList.add('sidebar-hidden');
                this.dom.hamburgerMenu.setAttribute('aria-pressed', false); // Sidebar is now hidden, so hamburger is not pressed
            });

            this.dom.contactList.addEventListener('click', (e) => {
                const contactItem = e.target.closest('.contact-item');
                const deleteBtn = e.target.closest('.delete-contact-btn');

                if (deleteBtn) {
                    e.stopPropagation();
                    if (confirm(`Are you sure you want to delete this contact?`)) {
                        this.deleteContact(deleteBtn.dataset.peerId);
                    }
                    return;
                }
                
                if (contactItem) {
                    const peerId = contactItem.dataset.peerId;
                    if(peerId === this.activePeerId && this.currentConnection) return;
                    
                    this.activePeerId = peerId;
                    this.renderContacts(); // Re-render to show active state
                    this.connectToPeer(peerId);
                    
                    if (window.innerWidth <= 768) {
                        this.dom.appContainer.classList.add('sidebar-hidden');
                        this.dom.hamburgerMenu.setAttribute('aria-pressed', false); // Update hamburger state on mobile close
                    }
                }
            });
            this.dom.copyIdBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(this.myPeerId)
                    .then(() => this.showToast('ID Copied!', 'success'))
                    .catch(err => this.showToast('Failed to copy ID.', 'error'));
            });
            this.dom.shareIdBtn.addEventListener('click', () => {
                const magicLink = `${location.href.split('#')[0]}#${this.myPeerId}`;
                // [MODIFIED JAVASCRIPT] - Clear the canvas context before drawing new QR code
                const ctx = this.dom.qrCodeCanvas.getContext('2d');
                ctx.clearRect(0, 0, this.dom.qrCodeCanvas.width, this.dom.qrCodeCanvas.height);
                
                // [MODIFIED JAVASCRIPT] - Target the actual canvas element
                QRCode.toCanvas(this.dom.qrCodeCanvas, magicLink, {width: 256}, (error) => {
                    if (error) {
                        console.error("QR Code generation error:", error);
                        this.showToast('Failed to generate QR code.', 'error');
                    }
                });
                this.showModal(this.dom.shareIdModal);
            });

            // Chat Area
            this.dom.hamburgerMenu.addEventListener('click', () => {
                const isHiddenAfterToggle = this.dom.appContainer.classList.toggle('sidebar-hidden');
                this.dom.hamburgerMenu.setAttribute('aria-pressed', !isHiddenAfterToggle);
            });
            this.dom.messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.sendMessage();
            });
            this.dom.ghostModeToggle.addEventListener('click', () => {
                this.ghostMode = !this.ghostMode;
                this.dom.ghostModeToggle.classList.toggle('active', this.ghostMode);
                this.addSystemMessage(`Ghost mode is now ${this.ghostMode ? 'ON' : 'OFF'}. Messages will disappear faster.`);
            });
            this.dom.fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(file) this.sendFile(file);
            });
             this.dom.messageList.addEventListener('click', (e) => {
                const translateBtn = e.target.closest('.translate-btn');
                if (translateBtn) {
                    this.handleTranslate(translateBtn);
                }
            });

            // Modals
            this.dom.saveContactBtn.addEventListener('click', () => this.saveContact());
            this.dom.cancelAddContactBtn.addEventListener('click', () => this.hideModal(this.dom.addContactModal));
            this.dom.addContactModal.addEventListener('click', (e) => {
                if(e.target === this.dom.addContactModal) this.hideModal(this.dom.addContactModal);
            });
            this.dom.shareLinkBtn.addEventListener('click', () => {
                const magicLink = `${location.href.split('#')[0]}#${this.myPeerId}`;
                if (navigator.share) {
                    navigator.share({
                        title: 'AetherLink Invitation',
                        text: 'Connect with me on AetherLink!',
                        url: magicLink,
                    }).catch(err => console.error("Share failed", err));
                } else {
                    navigator.clipboard.writeText(magicLink)
                        .then(() => this.showToast('Magic Link copied to clipboard!', 'success'))
                        .catch(err => this.showToast('Failed to copy link.', 'error'));
                }
            });
            this.dom.cancelShareBtn.addEventListener('click', () => this.hideModal(this.dom.shareIdModal));
            
            // Call Controls
            this.dom.voiceCallBtn.addEventListener('click', () => this.initiateCall(false));
            this.dom.videoCallBtn.addEventListener('click', () => this.initiateCall(true));
            this.dom.hangUpBtn.addEventListener('click', () => this.endCall());
            this.dom.toggleMicBtn.addEventListener('click', () => {
                const enabled = this.localStream.getAudioTracks()[0].enabled;
                this.localStream.getAudioTracks()[0].enabled = !enabled;
                this.dom.toggleMicBtn.classList.toggle('off', enabled);
            });
            this.dom.toggleCamBtn.addEventListener('click', () => {
                const enabled = this.localStream.getVideoTracks()[0].enabled;
                this.localStream.getVideoTracks()[0].enabled = !enabled;
                this.dom.toggleCamBtn.classList.toggle('off', enabled);
            });
            this.dom.acceptCallBtn.addEventListener('click', () => this.answerCall());
            this.dom.declineCallBtn.addEventListener('click', () => this.declineCall());
            
            // Window resize
            window.addEventListener('resize', () => {
                 if (window.innerWidth > 768) {
                    this.dom.appContainer.classList.remove('sidebar-hidden');
                 }
            });
        },
        
        async handleTranslate(btn) {
            btn.disabled = true;
            const messageBubble = btn.closest('.message-bubble');
            const messageContent = messageBubble.querySelector('.message-content');
            const originalText = messageContent.textContent;
            const targetLang = navigator.language.split('-')[0];

            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(originalText)}&langpair=auto|${targetLang}`);
                const data = await response.json();
                if (data.responseData && data.responseStatus === 200) {
                    const translatedText = data.responseData.translatedText;
                    const translationDiv = document.createElement('div');
                    translationDiv.className = 'translation-container';
                    translationDiv.textContent = translatedText;
                    messageContent.appendChild(translationDiv);
                } else {
                    this.showToast('Translation failed.', 'error');
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Translation error:', error);
                this.showToast('Translation service unavailable.', 'error');
                btn.disabled = false;
            }
        },

        // --- Helper & Data Methods ---
        loadContacts() {
            const contacts = localStorage.getItem('aetherlink-contacts');
            this.contacts = contacts ? JSON.parse(contacts) : [];
        },
        
        saveContact() {
            const name = this.dom.contactNameInput.value.trim();
            const peerId = this.dom.contactIdInput.value.trim();
            if (name && peerId) {
                if (this.contacts.some(c => c.peerId === peerId)) {
                    this.showToast('Contact with this Peer ID already exists.', 'error');
                    return;
                }
                this.contacts.push({ name, peerId });
                localStorage.setItem('aetherlink-contacts', JSON.stringify(this.contacts));
                this.renderContacts();
                this.hideModal(this.dom.addContactModal);
            }
        },
        
        deleteContact(peerId) {
            this.contacts = this.contacts.filter(c => c.peerId !== peerId);
            localStorage.setItem('aetherlink-contacts', JSON.stringify(this.contacts));
            this.renderContacts();
            
            if(this.activePeerId === peerId){
                if(this.currentConnection) this.currentConnection.close();
                this.updateChatUIForNoSelection();
                this.activePeerId = null;
            }
        },

        getContactByPeerId(peerId) {
            return this.contacts.find(c => c.peerId === peerId);
        },
        
        getContactName(peerId) {
            const contact = this.getContactByPeerId(peerId);
            return contact ? contact.name : 'Unknown Peer';
        },
        
        handleMagicLink() {
            const peerId = location.hash.substring(1);
            if (peerId && peerId !== this.myPeerId) {
                location.hash = ''; // Clear hash
                if (this.contacts.some(c => c.peerId === peerId)) {
                    this.showToast('You already have this contact. Selecting them now.');
                    // Find and click the contact
                    const contactEl = this.dom.contactList.querySelector(`[data-peer-id="${peerId}"]`);
                    if(contactEl) contactEl.click();
                } else {
                    this.dom.contactIdInput.value = peerId;
                    this.dom.contactNameInput.value = '';
                    this.showModal(this.dom.addContactModal);
                    this.showToast('Magic Link detected! Please name your new contact.');
                }
            }
        },
        
        async sendMessage() {
            const text = this.dom.messageInput.value.trim();
            if (text === '' || !this.currentConnection) return;
            
            try {
                const payload = { content: text, isImage: false };
                const encrypted = await this.encryptMessage(JSON.stringify(payload), this.activePeerId);
                this.currentConnection.send({ type: 'encrypted-message', payload: encrypted });
                
                this.addMessageToUI(text, 'mine');
                this.dom.messageInput.value = '';
            } catch(e) {
                console.error("Encryption/Send Error:", e);
                this.addSystemMessage("Failed to send message.");
            }
        },
        
        sendFile(file) {
            if (!this.currentConnection) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                const content = event.target.result;
                const isImage = file.type.startsWith('image/');

                try {
                     const payload = { content, isImage, fileName: file.name };
                     const encrypted = await this.encryptMessage(JSON.stringify(payload), this.activePeerId);
                     this.currentConnection.send({ type: 'encrypted-message', payload: encrypted });
                     this.addMessageToUI(content, 'mine', 'You', isImage, file.name);
                } catch(e) {
                    console.error("File Encryption/Send Error:", e);
                    this.addSystemMessage("Failed to send file.");
                }
            };
            reader.readAsDataURL(file);
        },

        dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], {type: mimeString});
        }
    };

    window.onload = () => App.init();
    </script>
</body></html>
